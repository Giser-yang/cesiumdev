!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("Cesium")):"function"==typeof define&&define.amd?define("cesiumMap",["Cesium"],t):"object"==typeof exports?exports.cesiumMap=t(require("Cesium")):e.cesiumMap=t(e.Cesium)}(this,(e=>(()=>{"use strict";var t={512:e=>{e.exports=function(e,t,i,n){var r=self||window;try{try{var o;try{o=new r.Blob([e])}catch(t){(o=new(r.BlobBuilder||r.WebKitBlobBuilder||r.MozBlobBuilder||r.MSBlobBuilder)).append(e),o=o.getBlob()}var s=r.URL||r.webkitURL,a=s.createObjectURL(o),l=new r[t](a,i);return s.revokeObjectURL(a),l}catch(n){return new r[t]("data:application/javascript,".concat(encodeURIComponent(e)),i)}}catch(e){if(!n)throw Error("Inline worker is not supported");return new r[t](n,i)}}},354:t=>{t.exports=e}},i={};function n(e){var r=i[e];if(void 0!==r)return r.exports;var o=i[e]={exports:{}};return t[e](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};n.d(r,{default:()=>ui});var o={};n.r(o),n.d(o,{compass:()=>M,zoomInOut:()=>C});var s={};n.r(s),n.d(s,{geojson:()=>E});var a={};n.r(a),n.d(a,{fence:()=>$,fill:()=>U,icon:()=>H,label:()=>V,line:()=>W,moveline:()=>Q,planning:()=>ee,svg:()=>J});var l={};n.r(l),n.d(l,{fence:()=>De,label:()=>me,model:()=>Te,moveline:()=>Ne,planning:()=>Mt,point:()=>de,polygon:()=>_e,polyline:()=>ve,svgpolygon:()=>ft,tiles3d:()=>Me});var h=n(354);function c(e){return function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).split(/\s+/)}function d(){return!1}var u=0;function p(e){return e._ugis_id=e._ugis_id||++u,e._ugis_id}function m(e){var t,i,n,r;for(i=1,n=arguments.length;i<n;i++)for(t in r=arguments[i])e[t]=r[t];return e}class g{constructor(){this.revision_=0}on(e,t,i){if("object"==typeof e)for(var n in e)this._on(n,e[n],t);else for(var r=0,o=(e=c(e)).length;r<o;r++)this._on(e[r],t,i);return this}off(e,t,i){if(e)if("object"==typeof e)for(var n in e)this._off(n,e[n],t);else for(var r=0,o=(e=c(e)).length;r<o;r++)this._off(e[r],t,i);else delete this._events;return this}_on(e,t,i){this._events=this._events||{};var n=this._events[e];n||(n=[],this._events[e]=n),i===this&&(i=void 0);for(var r={fn:t,ctx:i},o=n,s=0,a=o.length;s<a;s++)if(o[s].fn===t&&o[s].ctx===i)return;o.push(r)}_off(e,t,i){var n,r,o;if(this._events&&(n=this._events[e]))if(t){if(i===this&&(i=void 0),n)for(r=0,o=n.length;r<o;r++){var s=n[r];if(s.ctx===i&&s.fn===t)return s.fn=d,this._firingCount&&(this._events[e]=n=n.slice()),void n.splice(r,1)}}else{for(r=0,o=n.length;r<o;r++)n[r].fn=d;delete this._events[e]}}fire(e,t,i){if(!this.listens(e,i))return this;var n=m({},t,{type:e,target:this,data:t});if(this._events){var r=this._events[e];if(r){this._firingCount=this._firingCount+1||1;for(var o=0,s=r.length;o<s;o++){var a=r[o];a.fn.call(a.ctx||this,n)}this._firingCount--}}return i&&this._propagateEvent(n),this}changed(){++this.revision_,this.fire("change")}listens(e,t){var i=this._events&&this._events[e];if(i&&i.length)return!0;if(t)for(var n in this._eventParaents)if(this._eventParaents[n].listeners(e,t))return!0;return!1}once(e,t,i){if("object"==typeof e){for(var n in e)this.once(n,e[n],t);return this}var r=function(e,t){var i=Array.prototype.slice;if(e.bind)return e.bind.apply(e,i.call(arguments,1));var n=i.call(arguments,2);return function(){return e.apply(t,n.length?n.concat(i.call(arguments)):arguments)}}((function(){this.off(e,t,i).off(e,r,i)}),this);return this.on(e,t,i).on(e,r,i)}addEventParent(e){return this._eventParaents=this._eventParaents||{},this._eventParaents[p(e)]=e,this}removeEventParent(e){return this._eventParaents&&delete this._eventParaents[p(e)],this}_propagateEvent(e){for(var t in this._eventParaents)this._eventParents[t].fire(e.type,m({layer:e.target,propagatedFrom:e.target},e),!0)}clearListeners(){const e=this._events;if(e){let t;Object.keys(e).forEach((i=>{t=e[i],Array.isArray(t)&&t.forEach((e=>{e.ctx=null,e.fn=null})),t.length=0,delete e[i]})),this._events=null}}}const f=function(e,t,i,n){const r=document.createElement(e);return n&&(r.id=n),t&&v(r,t),i&&i.appendChild(r),r};function y(e,t){return-1!=e.className.split(/\s+/).indexOf(t)}function v(e,t){""!==e.className&&(t=" "+t),y(e,t)||(e.className+=t)}class x extends g{constructor(e,t){super(),this.options=t,this.mapInstance=e,this.viewer=e.viewer}setDisplay(){const e=this.options.display;this.$element.style.display=e?"block":"none"}setPosition(){let e=this.options,t=this.$element.style;switch(e.position){case"rt":t.removeProperty("left"),t.removeProperty("bottom"),t.setProperty("top",e.y+"px"),t.setProperty("right",e.x+"px");break;case"lt":t.removeProperty("right"),t.removeProperty("bottom"),t.setProperty("top",e.y+"px"),t.setProperty("left",e.x+"px");break;case"lb":t.removeProperty("right"),t.removeProperty("top"),t.setProperty("bottom",e.y+"px"),t.setProperty("left",e.x+"px");break;case"rb":t.removeProperty("left"),t.removeProperty("top"),t.setProperty("bottom",e.y+"px"),t.setProperty("right",e.x+"px")}}destroy(){this.$element&&(this.$element.parentElement.removeChild(this.$element),this.$element=null),this.clearListeners(),this.options=null,this.mapInstance=null,this.viewer=null}}const w={display:"block",position:"rb",x:20,y:220,size:30,backgroundColor:"#282828",iconColor:"rgba(255,255,255,1)"};class C extends x{constructor(e,t,i){super(e,t),this.options=Object.assign({},w,t),this.name="zoomPicker",this.$element=f("div","MAP3D-Control MAP3D-ZoomPicker",i),this.relativeAmount=2,this.init(),this.initStyle()}init(){const e=f("div","MAP3D-Button map3d-icon-plus",this.$element);e.title="放大",e.addEventListener("click",(e=>{this.zoomIn()})),this.zoomInbtn=e;const t=f("div","MAP3D-Button map3d-icon-home",this.$element);t.title="初始化",t.addEventListener("click",(e=>{this.zoomBack()})),this.homeBtn=t;const i=f("div","MAP3D-Button map3d-icon-minus",this.$element);i.title="缩小",i.addEventListener("click",(e=>{this.zoomOut()})),this.zoomOutBtn=i}initStyle(){this.setDisplay(),this.setPosition(),this.setSize(),this.setIconColor(),this.setBackgroundColor()}zoomIn(){this._changeCameraZoom(.5)}zoomOut(){this._changeCameraZoom(2)}_changeCameraZoom(e){const t=new h.Cartesian3,i=this.viewer,n=i.scene,r=n.camera;let o;switch(n.mode){case h.SceneMode.MORPHING:break;case h.SceneMode.SCENE2D:r.zoomIn(r.positionCartographic.height*(1-e));break;default:let s;if(s=(0,h.defined)(i.trackedEntity)?new h.Cartesian3:function(e,t,i){const n=new h.Cartographic,r=new h.Ray,o=e.scene,s=o.camera;if(o.mode!=h.SceneMode.MORPHING&&((0,h.defined)(i)||(i=new h.Cartesian3),(0,h.defined)(e.trackedEntity)?i=e.trackedEntity.position.getValue(e.clock.currentTime,i):(r.origin=s.positionWC,r.direction=s.directionWC,i=o.globe.pick(r,o,i)),(0,h.defined)(i)))return o.mode==h.SceneMode.SCENE2D||o.mode==h.SceneMode.COLUMBUS_VIEW?(i=s.worldToCameraCoordinatesPoint(i,i),t&&(i=o.globe.ellipsoid.cartographicToCartesian(o.mapProjection.unproject(i,n),i))):t||(i=s.worldToCameraCoordinatesPoint(i,i)),i}(i,!1),(0,h.defined)(s))o={direction:r.direction,up:r.up};else{const e=new h.Ray(r.worldToCameraCoordinatesPoint(n.globe.ellipsoid.cartographicToCartesian(r.positionCartographic)),r.directionWC);s=h.IntersectionTests.grazingAltitudeLocation(e,n.globe.ellipsoid),o={heading:r.heading,pitch:r.pitch,roll:r.roll}}const a=h.Cartesian3.subtract(r.position,s,t),l=h.Cartesian3.multiplyByScalar(a,e,a),c=h.Cartesian3.add(s,l,s);(0,h.defined)(i.trackedEntity)||n.mode==h.SceneMode.COLUMBUS_VIEW?r.position=c:r.flyTo({destination:c,orientation:o,duration:.5,convert:!1})}}zoomBack(){const e=this.viewer,t=e.scene.camera;if((0,h.defined)(e.trackedEntity)){const t=e.trackedEntity;e.trackedEntity=void 0,e.trackedEntity=t}else if(this.mapInstance.viewOptions){const e=this.mapInstance.viewOptions,{longitude:i,latitude:n,height:r,pitch:o,heading:s,roll:a}=e,l=h.Cartesian3.fromDegrees(i,n,r),c={heading:h.Math.toRadians(s),pitch:h.Math.toRadians(o),roll:a};t.flyTo({destination:l,orientation:c,duration:1,complete:()=>{}})}else t.flyTo({destination:h.Camera.DEFAULT_VIEW_RECTANGLE,duration:1})}setBackgroundColor(){const e=this.options.backgroundColor;for(let t of this.$element.children)t.style.background=e}setSize(){const e=this.options.size+"px",t=.7*this.options.size+"px";this.$element.style.width=e,this.$element.style.height=3*this.options.size+"px",this.zoomInbtn.style.width=e,this.zoomInbtn.style.height=e,this.zoomInbtn.style["line-height"]=e,this.zoomInbtn.style["font-size"]=t,this.homeBtn.style.width=e,this.homeBtn.style.height=e,this.homeBtn.style["line-height"]=e,this.homeBtn.style["font-size"]=t,this.zoomOutBtn.style.width=e,this.zoomOutBtn.style.height=e,this.zoomOutBtn.style["line-height"]=e,this.zoomOutBtn.style["font-size"]=t}setIconColor(){const e=this.options.iconColor;for(let t of this.$element.children)t.style.color=e}destory(){const e=this.$element;e.removeChild(this.zoomInbtn),this.zoomInbtn=null,e.removeChild(this.homeBtn),this.homeBtn=null,e.removeChild(this.zoomOutBtn),this.zoomOutBtn=null,super.destroy()}}const _=180/Math.PI,b={display:"block",position:"rb",x:10,y:320,size:50,rotate:90,iconColor:"rgba(255,255,255,1)",hoverColor:"rgb(27, 196, 197)",arrowColor:"rgba(255,255,255,1)",backgroundColor:"rgba(40, 40, 40,1)"};class M extends x{constructor(e,t,i){super(e,t),this.options=Object.assign({},b,t),this.name="compassPicker",this.$element=f("div","MAP3D-Control MAP3D-CompassPicker",i),this.viewer=e.viewer,this.camera=this.viewer.scene.camera,this.init(),this.initStyle()}init(){this.changedBind=this.updateRotate.bind(this),this.eventListener=this.camera.changed.addEventListener(this.changedBind),this.plate=f("div","map3d-icon-arrowPlate map3d-arrow",this.$element),this.centerCircle=f("div","map3d-icon-centerCircle map3d-arrow",this.$element),this.rightArrow=f("div","map3d-icon-arrowRight map3d-arrow",this.$element),this.leftArrow=f("div","map3d-icon-arrowLeft map3d-arrow",this.$element),this.northArrow=f("div","map3d-icon-arrowNorth map3d-arrow",this.$element);const e=this.leftBox=f("div","map3d-arrow-leftBox",this.$element);e.title="左旋转",this.handleMouseEvent(e,this.leftArrow),e.addEventListener("click",(e=>{this.hadleLeft(e)}));const t=this.rightBox=f("div","map3d-arrow-rightBox",this.$element);t.title="右旋转",this.handleMouseEvent(t,this.rightArrow),t.addEventListener("click",(e=>{this.hadleRight(e)}));const i=this.centerBox=f("div","map3d-arrow-centerBox",this.$element);i.title="返回",i.addEventListener("click",(e=>{this.hadleHome(e)}))}initStyle(){this.setDisplay(),this.setPosition(),this.setSize(),this.setIconColor(),this.updateRotate()}hadleHome(e){e.preventDefault();const t=this.camera.heading;this._changeCameraHeading(t)}hadleRight(e){e.preventDefault();const t=h.Math.toRadians(this.options.rotate);this._changeCameraHeading(t)}hadleLeft(e){e.preventDefault();const t=h.Math.toRadians(-1*this.options.rotate);this._changeCameraHeading(t)}handleMouseEvent(e,t){const{hoverColor:i,iconColor:n}=this.options;e.addEventListener("mouseover",(e=>{e.preventDefault(),t.style.color=i})),e.addEventListener("mouseout",(e=>{e.preventDefault(),t.style.color=n}))}_changeCameraHeading(e){const t=this.viewer,i=t.scene,n=i.camera;let r,o,s=n.position,a=h.Cartographic.fromCartesian(s);const l=n.heading-e;switch(i.mode){case h.SceneMode.MORPHING:case h.SceneMode.SCENE2D:break;default:let y,v;if(r={heading:l,pitch:n.pitch,roll:n.roll},i.mode===h.SceneMode.COLUMBUS_VIEW){a=n._positionCartographic,s=h.Cartographic.toCartesian(n._positionCartographic);const e=t._lastHeight/2,i=t._lastWidth/2,r=new h.Cartesian2(i,e);v=t.camera.getPickRay(r)}else v=new h.Ray(n.worldToCameraCoordinatesPoint(i.globe.ellipsoid.cartographicToCartesian(n.positionCartographic)),n.directionWC);if(y=t.scene.globe.pick(v,t.scene),y){var c=h.Cartographic.fromCartesian(y);c.height=Math.ceil(c.height);var d=h.Cartographic.toCartesian(c),u=h.Cartesian3.normalize(h.Cartesian3.subtract(d,y,new h.Cartesian3),new h.Cartesian3),p=h.Quaternion.fromAxisAngle(u,e),m=h.Matrix3.fromQuaternion(p),g=h.Matrix4.fromRotationTranslation(m);const t=h.Cartesian3.subtract(s,y,new h.Cartesian3);var f=h.Matrix4.multiplyByPoint(g,t,new h.Cartesian3);o=h.Cartesian3.add(f,y,new h.Cartesian3)}else o=n.position}o&&r&&n.flyTo({destination:o,orientation:r,duration:1,convert:!0,maximumHeight:a.height})}setSize(){const e=this.options.size+"px";this.$element.style.width=e,this.$element.style.height=e,this.$element.style["line-height"]=e,this.plate.style["font-size"]=e,this.centerCircle.style["font-size"]=.62*this.options.size+"px",this.centerCircle.style.opacity=.2,this.northArrow.style["font-size"]=e,this.leftArrow.style["font-size"]=e,this.rightArrow.style["font-size"]=e}setIconColor(){this.plate.style.color=this.options.backgroundColor,this.northArrow.style.color=this.options.arrowColor,this.centerCircle.style.color=this.options.arrowColor,this.leftArrow.style.color=this.options.iconColor,this.rightArrow.style.color=this.options.iconColor}updateRotate(){if("none"!=this.options.display){const e=this.camera.heading*_*-1;this.northArrow.style.rotate=e+"deg"}}destroy(){this.camera.changed.removeEventListener(this.changedBind),this.changedBind=null;const e=this.$element;e.removeChild(this.plate),e.removeChild(this.centerCircle),e.removeChild(this.rightArrow),e.removeChild(this.leftArrow),e.removeChild(this.northArrow),e.removeChild(this.leftBox),e.removeChild(this.rightBox),e.removeChild(this.centerBox),this.leftBox=null,this.centerCircle=null,this.rightArrow=null,this.leftArrow=null,this.northArrow=null,this.leftBox=null,this.rightBox=null,this.centerBox=null}}class A extends g{constructor(e){super(),this.mapInstance=e,this._element=f("div","MAP3D-Controller",e.viewer._element)}add(e,t){const i=o[e];let n;return i&&(n=new i(this.mapInstance,t,this._element)),n}}class T{constructor(e,t){const i=t||{};if(this.unique_=!!i.unique,this.array_=e||[],this.length_=0,this.unique_)for(let e=0,t=this.array_.length;e<t;e++)this.assertUnique_(this.array_[e],e);this.updateLength_()}clear(){for(;this.getLength()>0;)this.pop()}extend(e){for(let t=0,i=e.length;t<i;++t)this.push(e[t]);return this}forEach(e){const t=this.array_;for(let i=0,n=t.length;i<n;++i)e(t[i],i,t)}getArray(){return this.array_}item(e){return this.array_[e]}getLength(){return this.length_}insertAt(e,t){this.unique_&&this.assertUnique_(t),this.array_.splice(e,0,t),this.updateLength_()}pop(){return this.removeAt(this.getLength()-1)}push(e){this.unique_&&this.assertUnique_(e);const t=this.getLength();return this.insertAt(t,e),this.getLength()}remove(e){const t=this.array_;for(let i=0,n=t.length;i<n;++i)if(t[i]===e)return this.removeAt(i)}removeAt(e){const t=this.array_[e];return this.array_.splice(e,1),this.updateLength_(),t}setAt(e,t){const i=this.getLength();if(e<i){this.unique_&&this.assertUnique_(t,e);this.array_[e];this.array_[e]=t}else{for(let t=i;t<e;++t)this.insertAt(t,void 0);this.insertAt(e,t)}}updateLength_(){this.length_=this.array_.length}assertUnique_(e,t){for(let i=0,n=this.array_.length;i<n;++i)if(this.array_[i]===e&&i!==t)throw new Error}destroy(){this.clear(),this.clearListeners()}}class P extends g{constructor(e){super(),this.mapInstance=e,this.collection=new T}add(e){}get(e){return this.collection.getArray().find((t=>t.id===e))}remove(e){const t=this.getIndex(e);if(t<0)return;const i=this.collection.removeAt(t);i&&i.destroy&&i.destroy()}getIndex(e){return this.collection.getArray().findIndex((t=>t.id==e))}}class S extends g{constructor(e,t){super(),this.mapInstance=e,this.viewer=e.viewer,this.id=t.id,this.actor=this.mapInstance.dispatcher.getActor(),this.options=t,this.dataLoaded=!1,this.useLayerNumber=0,this._init()}_init(){}setData(e){}addUseLayer(){this.useLayerNumber++}removeUseLayer(){this.useLayerNumber--}destroy(){}}class E extends S{constructor(e,t){super(e,t)}_init(){const e=this.options.data;if(!e)return;const t={data:e,sourceId:this.id};this.loadData(t)}loadData(e){this.dataLoaded=!1,this.actor.send("load_geojson",e,(e=>{"success"===e.msgType&&(this.dataLoaded=!0,this.fire("source-dataUpdate"))}))}queryData(e,t){this.actor.send("query_geojson",{data:e,sourceId:this.id},(e=>{t(e)}))}clearData(){this.actor.send("clear_geojson",{sourceId:this.id},(e=>{console.log(e)}))}setData(e){const t={data:e,sourceId:this.id};this.loadData(t)}destroy(){this.useLayerNumber<1&&(console.log("destroy"),this.clearData())}}class D extends P{constructor(e){super(e)}add(e){const t=e.id;let i=this.get(t);if(!i)return i=new s[e.type](this.mapInstance,e),this.collection.push(i),i;console.error("存在相同id")}}const L="ONLINE",O="WMS",I="WMTS",R="ARCGIS",N=/\{([0-9]+)-([0-9]+)\}/,z={url:"",epsgCode:"EPSG:3857",dataLevel:[9,22],adjustLevel:0,tileMatrixList:[],extent:[-180,-90,180,90]};class F extends g{constructor(){super()}createLayer(e){const t=Object.assign(z,e),i=this.getCommonParams(t);let n;switch(t.type){case L:n=this.parseOnline(t);break;case O:case I:case R:break;default:n=this.parseOnline(t)}const{adjustLevel:r=0,epsgCode:o,params:s=[],extent:a}=t,l=a?new h.Rectangle.fromDegrees(a[0],a[1],a[2],a[3]):new h.Rectangle.fromDegrees(-180,-90,180,90),{subdomains:c,tempUrl:d}=this.processSubDomain(n),u=d.replace("{z}","{zp}"),p=this.getSource(u,s);return new h.UrlTemplateImageryProvider({url:p,rectangle:l,tilingScheme:i.tilingScheme,minimumLevel:i.minimumLevel,maximumLevel:i.maximumLevel,subdomains:c,customTags:{zp:function(e,t,i,n){return"EPSG:3857"===o?n:n+r+1}}})}getSource(e,t=[]){const i={},n={};return t.forEach((e=>{"Header_Param"===e.paramType?n[e.paramName]=e.paramValue:i[e.paramName]=e.paramValue})),new h.Resource({url:e,headers:n,queryParameters:i,proxy:null})}parseOnline(e){const{url:t}=e;return t}getCommonParams(e){const t=this.getTilingScheme(e.epsgCode);let i=0,n=22,{dataLevel:r}=e;return r&&(i=r[0]||0,n=r[1]||22),{minimumLevel:i,maximumLevel:n,tilingScheme:t}}getTilingScheme(e){return"EPSG:3857"===e?new h.WebMercatorTilingScheme:new h.GeographicTilingScheme}processSubDomain(e){const t=e.match(N)||[];let i=e,n=[];if(t.length>=3){const r=+t[1],o=+t[2];for(let e=r;e<=o;e++)n.push(e+"");i=e.replace(`{${r}-${o}}`,(()=>"{s}"))}return{subdomains:n,tempUrl:i}}}class B extends g{constructor(e,t,i,n=!0){super(),this.id=t,this.viewer=e,this.imageryLayers=e.imageryLayers,this._visible=n,this.addLayer(i,n)}get show(){return this._visible}set show(e){this.layer.show=e,this._visible=e}addLayer(e,t){this.layer=new h.ImageryLayer(e,{show:t}),this.imageryLayers.add(this.layer)}removeLayer(){this.findLayer()&&this.imageryLayers.remove(this.layer)}findLayer(){return this.imageryLayers.contains(this.layer)}destroy(){this.removeLayer()}}class k extends P{constructor(e){super(e),this.viewer=e.viewer,this.baseLayerFactory=new F}add(e){const t=e.id;let i=this.get(t);if(i)return void console.error("存在相同id");const n=this.baseLayerFactory.createLayer(e);return n?(i=new B(this.viewer,t,n,e.visible),this.collection.push(i),i):void 0}}const G=class{constructor(){this.options={}}getOptions(){return this.options}};class H extends G{constructor(e){super(e),this.options={},this.options.$options=e,this.options.image=e.image,this.options.show=e.show,this.options.scale=(0,h.defaultValue)(e.scale,1);let t=e.horizontalOrigin||"center",i=e.verticalOrigin||"center";if(this.options.horizontalOrigin=h.HorizontalOrigin[t.toUpperCase()],this.options.verticalOrigin=h.VerticalOrigin[i.toUpperCase()],Array.isArray(e.pixelOffset)){const t=(0,h.defaultValue)(e.pixelOffset[0],0),i=(0,h.defaultValue)(e.pixelOffset[1],0);this.options.pixelOffset=(0,h.defaultValue)(new h.Cartesian2.fromArray([t,i]),h.Cartesian2.ZERO)}else this.options.pixelOffset=h.Cartesian2.ZERO;return this.options.rotation=(0,h.defaultValue)(parseFloat(e.rotation)*Math.PI/180,0),this.options.pixelOffsetScaleByDistance=e.pixelOffsetScaleByDistance,this.options.width=e.width,this.options.height=e.height,this.options}}class V extends G{constructor(e){super(),this.options={},this.options.style=h.LabelStyle[(e.style||"FILL").toUpperCase()],this.options.show=e.show,this.options.font=e.font||"14px 微软雅黑",this.options.scale=void 0!==e.scale?e.scale:1,this.options.showBackground=!0,this.options.disableDepthTestDistance=e.depthTest?0:Number.POSITIVE_INFINITY,this.options.outlineWidth="number"==typeof e.outlineWidth?e.outlineWidth:1+.001*Math.random(),this.options.fillColor=h.Color.fromCssColorString(e.fillColor||"rgba(255,255,255,1)"),this.options.outlineColor=h.Color.fromCssColorString(e.outlineColor||"rgba(0,0,0,1)"),this.options.backgroundColor=h.Color.fromCssColorString(e.backgroundColor||"rgba(255,255,255,0)");let t=e.horizontalOrigin||"center",i=e.verticalOrigin||"center";this.options.horizontalOrigin=h.HorizontalOrigin[t.toUpperCase()],this.options.verticalOrigin=h.VerticalOrigin[i.toUpperCase()];var n=[0,0];return e.backgroundPadding&&Array.isArray(e.backgroundPadding)&&(n[0]=(0,h.defaultValue)(e.backgroundPadding[0],0),n[1]=(0,h.defaultValue)(e.backgroundPadding[1],0)),this.options.backgroundPadding=h.Cartesian2.fromArray(n),this.options.eyeOffset=h.Cartesian3.ZERO,this.options.pixelOffset=new h.Cartesian2.fromArray(e.pixelOffset),this.options.translucenyByDistance=e.translucenyByDistance,this.options.field=e.field||"",this.options}}class U extends G{constructor(e){super();let t,i="string"==typeof e.fillColor?e.fillColor:"rgba(255,0,0,1)";return this.options.fillColor=new h.Color.fromCssColorString(i),"color"===e.type&&(t=new h.Material({fabric:{type:"Color",uniforms:{color:new h.Color.fromCssColorString(i)}}})),this.options.appearance=new h.EllipsoidSurfaceAppearance({aboveGround:!1,material:t,renderState:h.RenderState.fromCache({depthTest:{enabled:!0},blending:h.BlendingState.DISABLED,depthMask:!0})}),this.options}}class W extends G{constructor(e){super(),this.options.width="number"==typeof e.width?e.width:0;let t,i="string"==typeof e.color?e.color:"rgba(255,255,255,1)",n="string"==typeof e.gapColor?e.gapColor:"rgba(255,255,255,0)",r="number"==typeof e.dashLength?e.dashLength:16,o="string"==typeof e.outlineColor?e.outlineColor:"rgba(0,0,0,1)";if("solid"===e.type){let n=(0,h.defaultValue)(e.outlineWidth,0);this.options.width+=2*n,t=0===e.outlineWidth?new h.Material({fabric:{type:"Color",uniforms:{color:new h.Color.fromCssColorString(i)}}}):new h.Material({fabric:{type:"PolylineOutline",uniforms:{color:new h.Color.fromCssColorString(i),outlineColor:new h.Color.fromCssColorString(o),outlineWidth:2*n}}})}else"dash"===e.type&&(t=new h.Material({fabric:{type:"PolylineDash",uniforms:{color:new h.Color.fromCssColorString(i),gapColor:new h.Color.fromCssColorString(n),dashLength:2*r}}}));return this.options.appearance=new h.PolylineMaterialAppearance({material:t,renderState:h.RenderState.fromCache({depthTest:{enabled:!0},blending:h.BlendingState.DISABLED,depthMask:!0})}),this.options}}const j="\nin vec2 v_st;\nfloat PI = 3.1415926;\n\nvoid main() {\n    czm_materialInput materialInput;\n\n    czm_material material=czm_getMaterial(materialInput,v_st);\n    vec4 imageColor=vec4(material.diffuse,material.alpha);\n    vec3 imgColor = vec3(imageColor.rgb);\n    float imgAlpha = float(imageColor.a);\n\n    #ifdef HAS_LINE\n        float duration = getDuration();\n        float lineCount = getLineCount();\n        float lineWidth = getLineWidth();\n        float time= fract( czm_frameNumber / (duration * 60.0));//此处只考虑了60帧电脑\n        float value = abs(sin((v_st.t - time) * lineCount * PI));\n        vec4 lineRGBA = getLineColor();\n        vec3 lineColor = vec3(lineRGBA.rgb);\n        float lineAlpha = float(lineRGBA.a);\n        \n        if (fwidth(value) < lineWidth * lineCount) {\n            if (value < lineWidth) {\n                imgColor = lineColor;\n                imgAlpha = lineAlpha;\n            }\n        }\n        \n    #endif\n\n    out_FragColor = vec4(imgColor,  (1.0-v_st.t) * imgAlpha);\n}",q="FenceLine";h.Material.FenceLineType=q,h.Material._materialCache.addMaterial(q,{fabric:{type:q,uniforms:{lineWidth:.05,duration:3,lineColor:new h.Color(.23,.67,.9,1),lineCount:2,tx:""},source:"\nuniform float duration;\nfloat getDuration(){\n    return duration;\n}\n\nuniform float lineWidth;\nfloat getLineWidth(){\n    return lineWidth;\n}\n\nuniform float lineCount;\nfloat getLineCount(){\n    return lineCount;\n}\n\nuniform vec4 lineColor;\nvec4 getLineColor(){\n    return lineColor;\n}\n    \nuniform sampler2D tx;\nczm_material czm_getMaterial(czm_materialInput materialInput,vec2 v_st){\n    vec4 color = texture(tx, v_st);\n    czm_material material = czm_getDefaultMaterial(materialInput);\n    material.diffuse= color.rgb;\n    material.alpha=color.a;\n    return material;\n}\n"},translucent:!0});class Z extends h.Appearance{constructor(e){const t=e.lineCount;super({material:new h.Material({fabric:{type:q,uniforms:e}}),renderState:h.RenderState.fromCache({cull:{enabled:!1,face:h.CullFace.BACK},depthTest:{enabled:!0,func:h.DepthFunction.LESS},depthMask:!1}),fragmentShaderSource:t>0?"#define HAS_LINE\n"+j:j,vertexShaderSource:"\nin vec3 position3DHigh;\nin vec3 position3DLow;\nin float batchId;\nin vec3 normal;\nin vec2 st;\n\nout vec3 v_positionEC;\nout vec3 v_normalEC;\nvec4 computePosition(vec3 high,vec3 low){\n    return czm_translateRelativeToEye(high,low);\n}\n\nout vec2 v_st;\nvoid main() {\n    // 这三个相等czm_computePosition = computePosition = czm_translateRelativeToEye;\n    vec4 p = czm_computePosition();\n    // vec4 p = computePosition(position3DHigh,position3DLow);\n    // v_positionEC = (czm_modelViewRelativeToEye * p).xyz;      // position in eye coordinates\n    // v_normalEC = czm_normal * normal;    \n    v_st = st;\n    gl_Position = czm_modelViewProjectionRelativeToEye * p;\n\n    //下面这套也能算，但有精度丢失\n    //vec4 p = vec4(position3DHigh+position3DLow,1.0)\n    //gl_Position = czm_modelViewProjection * p; \n    //gl_Position = czm_modelViewInfiniteProjection * p;\n\n    //下面是转屏幕坐标，在回来,没有精度丢失\n    // vec4 position = computePosition(position3DHigh,position3DLow);\n    // vec4 positionEC = (czm_modelViewRelativeToEye * position);\n    // vec4 positionWindow = czm_eyeToWindowCoordinates(positionEC);\n    // vec4 translatePosition = vec4(positionWindow.x,positionWindow.y,-positionWindow.z, 1.0)*(czm_projection *vec4(positionEC.xyz,1.0)).w;\n    // gl_Position = czm_viewportOrthographic * translatePosition;\n    \n}\n"})}}const Y={width:32,height:128,gradients:[[0,"red"],[.5,"green"],[1,"blue"]]};class $ extends G{constructor(e){super();const{duration:t,lineCount:i,lineWidth:n,lineColor:r,color:o}=e,s=function(e){const t=Object.assign({},Y,e),i=document.createElement("canvas");i.width=Number(t.width),i.height=Number(t.height);const n=i.getContext("2d"),r=n.createLinearGradient(t.width/2,0,t.width/2,t.height);return t.gradients.forEach((e=>{r.addColorStop(e[0],e[1])})),n.fillStyle=r,n.fillRect(0,0,t.width,t.height),i}({width:32,height:128,gradients:o}),a={lineWidth:n,duration:t,lineColor:h.Color.fromCssColorString(r),lineCount:i,tx:s};return this.options.appearance=new Z(a),this.options}}const X="MoveLine";h.Material.MoveLineType=X,h.Material._materialCache.addMaterial(X,{fabric:{type:X,uniforms:{lineWidth:4,lineColor:new h.Color(.23,.67,.9,1),outColor:new h.Color(.23,.67,.9,1),resolution:0,tx:""},source:"\n\nuniform float lineWidth;\nfloat getLineWidth(){\n    return lineWidth;\n}\nuniform vec4 lineColor;\nvec4 getLineColor(){\n    return lineColor;\n}\n\nuniform vec4 outColor;\nvec4 getOutColor(){\n    return outColor;\n}\n\nuniform float resolution;\nfloat getResolution(){\n    return resolution;\n}\n\nuniform sampler2D tx;\nczm_material czm_getMaterial(czm_materialInput materialInput,vec2 v_st){\n    vec4 color = texture(tx, vec2(fract(v_st.s),fract(v_st.t)));\n    czm_material material = czm_getDefaultMaterial(materialInput);\n    material.diffuse= color.rgb;\n    material.alpha=color.a;\n    \n    return material;\n}\n"},translucent:!0});class K extends h.Appearance{constructor(e){super({material:new h.Material({fabric:{type:X,uniforms:e}}),renderState:h.RenderState.fromCache({depthTest:{enabled:!0},blending:h.BlendingState.DISABLED,depthMask:!0}),fragmentShaderSource:"\n\nin vec2 v_st;\nin vec2 v_uv;\nin float v_metersPerPixel;\nin vec2 v_normal;\nin float v_width;\n\nfloat fillPixelLength = 20.0;\nfloat dashPixelLength = 12.0;\n\nvoid main() {\n    vec4 position = czm_windowToEyeCoordinates(gl_FragCoord);\n    float pixelWidth = czm_metersPerPixel(position,czm_pixelRatio);\n    \n    float fillLength = fillPixelLength * v_metersPerPixel;\n    float dashLength = dashPixelLength * v_metersPerPixel;\n\n    // 每一段总长度\n    float markerdelta = fillLength + dashLength;\n    //fill的一半\n    float halfd = markerdelta / 2.0;\n    // uv.u对markerDelta取模求出其所在间隔中的所占的长度\n    float muvx = mod(v_uv.s , markerdelta);\n\n\n    vec4 color = getLineColor();\n    vec4 outColor = getOutColor();\n\n\n    // 在虚线范围内则贴图或者虚线\n    if(muvx >= halfd && muvx <= halfd + dashLength) {\n        float u = (muvx - halfd) / dashLength; // 算出贴图uv.u\n        czm_materialInput materialInput;\n        czm_material material=czm_getMaterial(materialInput,vec2(u, v_uv.t));\n        vec4 imageC = vec4(material.diffuse,material.alpha); // 拿到纹素\n        color.xyzw = mix(color, imageC, imageC.w); // 纹理颜色与线段颜色融合\n        // color = vec4(1.0,0.0,0.0,1.0);\n    }\n\n    //处理抗锯齿，看着更平滑\n    float lineHalfWidth = getLineWidth();\n    float dist = length(v_normal) * lineHalfWidth;// 计算出像素到线的距离（以像素为单位）\n    float blur = clamp(lineHalfWidth - dist , 0., 1.0); // 算出blur值，该算法巧妙之处在于此，像素距离线中间越近则dist越小，所以blur越大，像素越靠近线边缘dist越大所以blur越小\n    \n    float border = lineHalfWidth - dist ;\n   \n    if(border<4.0){\n        color = outColor;\n    }\n    out_FragColor = czm_gammaCorrect(color);\n    // out_FragColor.a *= blur;\n}",vertexShaderSource:"\nin vec3 position3DHigh;\nin vec3 position3DLow;\nin vec3 prev3DHigh;\nin vec3 prev3DLow;\nin vec3 next3DHigh;\nin vec3 next3DLow;\n\nin vec2 side;\nin vec2 uv;\n\n//未使用，但必须传入\nin float batchId;\nin vec3 normal;\nin vec2 st;\n\n//shaderSource上挂载仅供FS使用，这里需要自己去找到对应uniform名称\nuniform float lineWidth_0;\nuniform float resolution_3;\n\nout vec2 v_normal;\nout vec2 v_uv;\nout float v_width;\nout float v_metersPerPixel;\nvec4 computePosition(vec3 high,vec3 low){\n    return czm_translateRelativeToEye(high,low);\n}\n\n\n\nvoid main() {\n    float i_side = side.s;\n    float d_side = side.t;\n    float width = lineWidth_0 / 2.0;\n    //对于相机的坐标\n    vec4 position = computePosition(position3DHigh,position3DLow);\n    vec4 previous =  computePosition(prev3DHigh,prev3DLow);\n    vec4 next =  computePosition(next3DHigh,next3DLow);\n    vec4 positionEC = (czm_modelViewRelativeToEye * position);\n    vec4 prevEC = (czm_modelViewRelativeToEye * previous);\n    vec4 nextEC = (czm_modelViewRelativeToEye * next);\n\n    // 屏幕坐标\n    vec4 positionWindow = czm_eyeToWindowCoordinates(positionEC);\n    vec4 previousWindow = czm_eyeToWindowCoordinates(prevEC);\n    vec4 nextWindow = czm_eyeToWindowCoordinates(nextEC);\n\n    // prev\n    vec2 directionToPrevWC = positionWindow.xy - previousWindow.xy;\n    // next\n    vec2 directionToNextWC = nextWindow.xy - positionWindow.xy;\n\n    vec2 normalDirection = vec2(0.0, 0.0);//定义空的方向向量\n\n    float meterScaler = width;//宽度\n    if(abs(positionWindow.x - previousWindow.x) == 0. && abs(positionWindow.y - previousWindow.y) == 0.) { // 第一个点\n     directionToNextWC = normalize(directionToNextWC);\n     normalDirection = vec2(-directionToNextWC.y, directionToNextWC.x);\n    } else if (abs(positionWindow.x - nextWindow.x) == 0. && abs(positionWindow.y - nextWindow.y)== 0.) { // 最后一个点\n     directionToPrevWC = normalize(directionToPrevWC); // 取得单位向量\n     normalDirection = vec2(-directionToPrevWC.y, directionToPrevWC.x); // 取法向量\n\n    } else { // 中间点\n     directionToNextWC = normalize(directionToNextWC); // next方向向量\n     directionToPrevWC = normalize(directionToPrevWC); // last方向向量\n     vec2 lastNormal = vec2(-directionToPrevWC.y, directionToPrevWC.x); // 取last法向量\n     vec2 normalAvg = directionToPrevWC + directionToNextWC; // Avg向量\n     normalDirection = normalize(vec2(-normalAvg.y, normalAvg.x)); // 拐角处法向量,旋转90度\n     meterScaler = width / dot(normalDirection, lastNormal); // 法线方向上偏移的长度\n     //meterScaler = width / (normalDirection.x*lastNormal.y - normalDirection.y*lastNormal.x); // 法线方向上偏移的长度\n    }\n    \n    vec2 offset = normalDirection * i_side * meterScaler * czm_pixelRatio;\n\n    float v_length = sqrt((offset.x * offset.x) + (offset.y * offset.y));\n    float dirpixelLength =sqrt(abs((v_length * v_length) - (width * width)));\n    if(dirpixelLength> 2.0 * meterScaler){\n        offset = offset * ((2.0 * meterScaler) / dirpixelLength);\n    }\n    \n    vec2 windowCoords = positionWindow.xy + offset;\n    //此处计算有问题，界面会闪烁\n    vec4 translatePosition = vec4(windowCoords.x, windowCoords.y, -positionWindow.z, 1.0)*(czm_projection * vec4(positionEC.xyz,1.0)).w;\n    gl_Position = czm_viewportOrthographic * translatePosition;\n\n     v_normal = normalize(vec2(offset));\n     v_width = width;\n    v_metersPerPixel = max(0.0,resolution_3);//max(0.0, czm_metersPerPixel(positionEC));\n\n    v_length = sqrt((offset.x * offset.x) + (offset.y * offset.y));\n    dirpixelLength =sqrt(abs((v_length * v_length) - (width * width)));\n\n    v_uv = uv;\n    v_uv.s = (v_uv.s + (dirpixelLength* i_side * d_side  * v_metersPerPixel));\n}\n"})}}class Q extends G{constructor(e){super();const{width:t,color:i,imageUrl:n,outColor:r}=e,o={lineWidth:t,lineColor:new h.Color.fromCssColorString(i),outColor:new h.Color.fromCssColorString(r),resolution:0,tx:n};return this.options.appearance=new K(o),this.options}}class J extends G{constructor(e){super();const t={u_color:()=>new h.Color.fromCssColorString(e.topColor)},i={u_color:()=>new h.Color.fromCssColorString(e.sideColor),u_lineColor:()=>new h.Color.fromCssColorString(e.lineColor)};return this.options.top=t,this.options.side=i,this.options}}class ee extends G{constructor(e){super();const t={u_color:()=>new h.Color.fromCssColorString(e.color)};return this.options.uniform=t,this.options}}const te={EQUAL:function(e,t){return e==t},NO_EQUAL:function(e,t){return e!=t},GREATER_THAN:function(e,t){return e>t},GREATER_THAN_E:function(e,t){return e>=t},LESS_THAN:function(e,t){return e<t},LESS_THAN_E:function(e,t){return e<=t},LIKE:function(e,t){return e&&-1!==e.indexOf(t)},NOT_LIKE:function(e,t){return e&&-1===e.indexOf(t)},L_LIKE:function(e,t){return e&&0===e.indexOf(t)},L_NOT_LIKE:function(e,t){return e&&0!==e.indexOf(t)},R_LIKE:function(e,t){return e&&e.length===t.length+e.lastIndexOf(t)},R_NOT_LIKE:function(e,t){return e&&e.length!==t.length+e.lastIndexOf(t)},IN:function(e,t){return t.includes(e)},NOT_IN:function(e,t){return!t.includes(e)},IS_NULL:function(e){return null===e},IS_NOT_NULL:function(e){return null!==e},IS_EMPTY:function(e){return""===e},IS_NOT_EMPTY:function(e){return""!==e}};function ie(e,t){const{expressions:i,relation:n}=e;if(Array.isArray(i)&&i.length>0){let e=!1,r=0;for(let n=i.length,o=0;o<n;o++){const n=i[o];n&&(e=n.operator?te[n.operator](t[n.left.asColumnName],n.right.queryExpression.values[0]):ie(n,t),e&&(r+=1))}let o=!1;switch(n){case"AND":default:o=i.length===r;break;case"OR":o=r>0}return o}return!1}function ne(e,t){return!!t&&ie(t,e.properties)}const re=["AND","OR"],oe={"==":"EQUAL","!=":"NO_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_E","<":"LESS_THAN","<=":"LESS_THAN_E"};class se{constructor(e,t){if(this.relation="AND",this.expressions=[],re.includes(e[0])){this.relation=e[0];for(let t=1;t<e.length;t++)this.expressions.push(this.create(e[t]))}else this.expressions.push(this.create(e));this.style=t}create(e){return e.length<3||e.length>4?null:{operator:oe[e[1]],left:{asColumnName:e[0]},right:{queryExpression:{dataType:"string",values:[e[2]]}}}}}class ae{constructor(){this.basicStyle=null,this.conditionStyles=null}update(e,t){let i={},n=[];for(let t in e)i[t]=new a[t](e[t]);t&&t.forEach((e=>{if(e.condition){let t={};const i=e.style;for(let e in i)t[e]=new a[e](i[e]);n.push(new se(e.condition,t))}})),this.basicStyle=i,this.conditionStyles=n}dofilter(e){const t=this.basicStyle,i=this.conditionStyles;let n=null;for(let t=i.length-1;t>=0;t--){const r=i[t];if(ne(e,r)){n=r.style;break}}return n||(n=t),n}destroy(){this.basicStyle=null,this.conditionStyles=null}}const le=class{constructor(e,t){this.id=t.id,this.type=t.type,this.mapInstance=e,this.viewer=e.viewer,this.scene=this.viewer.scene,this.options=t,this.primitives=this.scene.primitives,this.styleFunction=t.styleFunction,this._boundingSpheres=null,this._features=null,this._initSource(t.source)}_initSource(e){if(["model","tiles3d"].includes(this.type))return;const t=this.mapInstance.getSource(e);t?(this.source=t,this.source.addUseLayer(),this.source.on("source-dataUpdate",this.queryData.bind(this))):console.error("不存在source")}updateFeatures(){}setFilter(e){this.options.filter=e,this.queryData()}clearData(){this._boundingSpheres=null}flyTo(){this.getVisible()&&this._boundingSpheres&&this.viewer.camera.flyToBoundingSphere(this._boundingSpheres)}show(){}hide(){}getVisible(){}destroy(){this.clearData(),this.source.removeUseLayer(),this.options=null,this._features=null,this.styleFunction&&(this.styleFunction=null)}},he={visible:!0,height:{type:"clamp",value:0,field:""},distanceDisplay:[0,2e7]},ce={show:!0,image:"./images/ball.png",scale:1,erticalOrigin:"center",horizontalOrigin:"center",pixelOffset:[0,0],rotation:0,width:null,height:null};class de extends le{constructor(e,t){super(e,t),this.type="point",t.config=Object.assign({},he,t.config),this.billboardCollection=this.primitives.add(new h.BillboardCollection({scene:this.scene})),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={icon:Object.assign({},ce,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{icon:Object.assign({},ce,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"point",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options.config,i=t.height,n=t.distanceDisplay,r=this.getDistanceDisplayCondition(n);let{type:o,value:s,field:a}=i,l=s,c=h.HeightReference.NONE;"relative"==o&&(c=h.HeightReference.RELATIVE_TO_GROUND),"clamp"==o&&(c=h.HeightReference.CLAMP_TO_GROUND,l=s=0,a="");let d=[];for(let t=0,i=e.length;t<i;t++){let i,n=e[t],o=n.geometry.type;if("Point"!==o&&"MultiPoint"!==o)continue;const s=this.conditionFilter.dofilter(n);let u=n.geometry.coordinates,p=n.properties;l=c!=h.HeightReference.CLAMP_TO_GROUND&&a?p[a]:l,i="Point"===o?h.Cartesian3.fromDegrees(u[0],u[1],l):h.Cartesian3.fromDegrees(u[0][0],u[0][1],l);const m={feature:n,layer:this},g=Object.assign({id:m,heightReference:c,distanceDisplayCondition:r,position:i},s.icon);this.styleFunction&&this.styleFunction(n,g),this.billboardCollection.add(g),d.push(i)}this._boundingSpheres=this.computeBoundingSphere(d)}setVisible(e){this.billboardCollection.show=e}getVisible(){return this.billboardCollection.show}computeBoundingSphere(e){return e.length>0?h.BoundingSphere.fromPoints(e):void 0}getDistanceDisplayCondition(e){return new h.DistanceDisplayCondition(parseFloat(e[0]),parseFloat(e[1]))}clearData(){super.clearData(),this.billboardCollection.removeAll()}destroy(){super.destroy(),this.billboardCollection.removeAll(),this.billboardCollection.destroy(),this.primitives.remove(this.billboardCollection),this.conditionFilter.destroy()}}const ue={visible:!0,height:{type:"clamp",value:0,field:""},distanceDisplay:[0,2e7]},pe={show:!0,field:"NAME",font:"bold 12px MicroSoft YaHei",scale:1,erticalOrigin:"center",horizontalOrigin:"center",pixelOffset:[0,-20]};class me extends le{constructor(e,t){super(e,t),this.type="label",t.config=Object.assign({},ue,t.config),this.labelCollection=this.primitives.add(new h.LabelCollection({scene:this.scene})),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={label:Object.assign({},pe,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{label:Object.assign({},pe,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"point",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options.config,i=t.height,n=t.distanceDisplay,r=this.getDistanceDisplayCondition(n);let{type:o,value:s,field:a}=i,l=s,c=h.HeightReference.NONE;"relative"==o&&(c=h.HeightReference.RELATIVE_TO_GROUND),"clamp"==o&&(c=h.HeightReference.CLAMP_TO_GROUND,l=s=0,a="");let d=[];for(let t=0,i=e.length;t<i;t++){let i,n=e[t],o=n.geometry.type;if("Point"!==o&&"MultiPoint"!==o)continue;const s=this.conditionFilter.dofilter(n);let u=n.geometry.coordinates,p=n.properties;l=c!=h.HeightReference.CLAMP_TO_GROUND&&a?p[a]:l,i="Point"===o?h.Cartesian3.fromDegrees(u[0],u[1],l):h.Cartesian3.fromDegrees(u[0][0],u[0][1],l);const m={feature:n,layer:this},g=Object.assign({id:m,heightReference:c,text:p[s.label.field],distanceDisplayCondition:r,position:i},s.label);this.styleFunction&&this.styleFunction(n,g),this.labelCollection.add(g),d.push(i)}this._boundingSpheres=this.computeBoundingSphere(d)}setVisible(e){this.labelCollection.show=e}getVisible(){return this.labelCollection.show}computeBoundingSphere(e){return e.length>0?h.BoundingSphere.fromPoints(e):void 0}getDistanceDisplayCondition(e){return(0,h.DistanceDisplayCondition)(parseFloat(e[0]),parseFloat(e[1]))}clearData(){super.clearData(),this.labelCollection.removeAll()}destroy(){super.destroy(),this.labelCollection.removeAll(),this.labelCollection.destroy(),this.primitives.remove(this.labelCollection),this.conditionFilter.destroy()}}class ge{constructor(){}static create(e,t){const i=e.geometry,n=[];switch(i.type.toUpperCase()){case"LINESTRING":n.push(this.createGeometry(i.coordinates,t));break;case"MULTILINESTRING":for(let e=0,r=i.coordinates.length;e<r;e++)n.push(this.createGeometry(i.coordinates[e],t));break;case"POLYGON":for(let e=0,r=i.coordinates.length;e<r;e++)n.push(this.createGeometry(i.coordinates[e],t));break;case"MULTIPOLYGON":for(let e=0,r=i.coordinates.length;e<r;e++)for(let r=0,o=i.coordinates[e].length;r<o;r++)n.push(this.createGeometry(i.coordinates[e][r],t))}return n}static createGeometry(e,t){const{height:i,width:n,heightType:r}=t;let o,s,a=[];if("clamp"===r){for(let t=0,i=e.length;t<i;t++){const i=e[t];a.push(i[0]),a.push(i[1]),a.push(0)}o=h.Cartesian3.fromDegreesArrayHeights(a),s=new h.GroundPolylineGeometry({positions:o,width:n,vertexFormat:h.PolylineMaterialAppearance.VERTEX_FORMAT})}else{for(let t=0,n=e.length;t<n;t++){const n=e[t];a.push(n[0]),a.push(n[1]),a.push(i)}o=h.Cartesian3.fromDegreesArrayHeights(a),s=new h.PolylineGeometry({positions:o,width:n,vertexFormat:h.PolylineMaterialAppearance.VERTEX_FORMAT})}return s}}const fe={visible:!0,height:{type:"none",value:0},distanceDisplay:[0,2e7]},ye={type:"solid",width:4,color:"rgba(255,0,0,1)",outlineWidth:4,outlineColor:"rgba(0,255,0,1)",gapColor:"rgba(0,255,0,1)",dashLength:4};class ve extends le{constructor(e,t){super(e,t),this.type="polyline",t.config=Object.assign({},fe,t.config),this.polylines=this.primitives.add(new h.PrimitiveCollection),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={line:Object.assign({},ye,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{line:Object.assign({},ye,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"lineString",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options;let i=[],{type:n,value:r}=t.config.height;const o=this.getDistanceDisplayCondition(t.config.distanceDisplay);for(let t=0,s=e.length;t<s;t++){const s=e[t],a=this.conditionFilter.dofilter(s),{width:l,appearance:c}=a.line,d=ge.create(s,{heightType:n,width:l,height:r}).map((e=>(i.push(h.BoundingSphere.fromPoints(e._positions)),new h.GeometryInstance({id:{feature:s,layer:this},geometry:e,attributes:{distanceDisplayCondition:o}})))),u=new("clamp"===n?h.GroundPolylinePrimitive:h.Primitive)({geometryInstances:d,appearance:c});this.styleFunction&&this.styleFunction(s,u),this.polylines.add(u)}this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres(i)}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.polylines.show=e}getVisible(){return this.polylines.show}clearData(){super.clearData(),this.polylines.removeAll()}destroy(){super.destroy(),this.polylines.removeAll(),this.polylines.destroy(),this.primitives.remove(this.polylines),this.conditionFilter.destroy()}}class xe{constructor(){}static create(e,t){const i=e.geometry,n=[];switch(i.type.toUpperCase()){case"POLYGON":const e=this.createGeometry(i.coordinates,t);n.push(e);break;case"MULTIPOLYGON":for(let e=0,r=i.coordinates.length;e<r;e++){const r=this.createGeometry(i.coordinates[e],t);n.push(r)}}return n}static createGeometry(e,t){const i=t.height,n=t.extrudedHeight;let r=e,o=[],s=[];for(let e=0,t=r.length;e<t;e++)if(0===e){r[e].push(r[e][r[e].length-1]);for(let t=0,n=r[e].length;t<n-1;t++){let n=r[e][t];o.push(n[0]),o.push(n[1]),o.push(i)}}else{let t=[];for(let n=0,o=r[e].length;n<o-1;n++){let o=r[e][n];t.push(o[0]),t.push(o[1]),t.push(i)}s.push({positions:h.Cartesian3.fromDegreesArrayHeights(t)})}let a={positions:h.Cartesian3.fromDegreesArrayHeights(o),holes:s};return new h.PolygonGeometry({polygonHierarchy:a,vertexFormat:h.EllipsoidSurfaceAppearance.VERTEX_FORMAT,extrudedHeight:parseFloat(n)+parseFloat(i),height:i})}}const we={visible:!0,height:{type:"clamp",extrudedHeight:0,value:0},distanceDisplay:[0,2e7]},Ce={type:"color",fillColor:"rgba(255,0,0,1)"};class _e extends le{constructor(e,t){super(e,t),this.type="polygon",t.config=Object.assign({},we,t.config),this.polygons=this.primitives.add(new h.PrimitiveCollection),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={fill:Object.assign({},Ce,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{fill:Object.assign({},Ce,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"polygon",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options;let i=[],{type:n,value:r,extrudedHeight:o}=t.config.height;const s=this.getDistanceDisplayCondition(t.config.distanceDisplay);for(let t=0,a=e.length;t<a;t++){const a=e[t],l=this.conditionFilter.dofilter(a),c=xe.create(a,{height:r,extrudedHeight:o}).map((e=>(i.push(h.BoundingSphere.fromPoints(e._polygonHierarchy.positions)),new h.GeometryInstance({id:{feature:a,layer:this},geometry:e,attributes:{distanceDisplayCondition:s}}))));let d=new("clamp"===n?h.GroundPrimitive:h.Primitive)({geometryInstances:c,appearance:l.fill.appearance});this.styleFunction&&this.styleFunction(a,d),this.polygons.add(d)}this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres(i)}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.polygons.show=e}getVisible(){return this.polygons.show}clearData(){super.clearData(),this.polygons.removeAll()}destroy(){super.destroy(),this.polygons.removeAll(),this.polygons.destroy(),this.primitives.remove(this.polygons),this.conditionFilter.destroy()}}const be={visible:!0,translate:[0,0,0],rotate:[0,0,0],scale:1};class Me extends le{constructor(e,t){super(e,t),t.config=Object.assign({},be,t.config),this.tileset=null,this.addTiles()}async addTiles(){const e=this.options.url,{show:t}=this.options.config;try{this.tileset=this.primitives.add(await h.Cesium3DTileset.fromUrl(e,{show:t,cacheBytes:536870912,maximumCacheOverflowBytes:536870912,maximumScreenSpaceError:2,cullWithChildrenBounds:!0,cullRequestsWhileMoving:!0,cullRequestsWhileMovingMultiplier:80,preloadWhenHidden:!0,preloadFlightDestinations:!0,preferLeaves:!1,dynamicScreenSpaceError:!1,dynamicScreenSpaceErrorDensity:2e-4,dynamicScreenSpaceErrorFactor:24,dynamicScreenSpaceErrorHeightFalloff:.25,progressiveResolutionHeightFraction:.3,foveatedScreenSpaceError:!0,foveatedConeSize:.1,foveatedMinimumScreenSpaceErrorRelaxation:0,foveatedTimeDelay:.1,skipLevelOfDetail:!0,baseScreenSpaceError:512,skipScreenSpaceErrorFactor:16,skipLevels:1,immediatelyLoadDesiredLevelOfDetail:!1,loadSiblings:!1,enableShowOutline:!1})),this.tileset.allTilesLoaded.addEventListener((function(){})),this.setPosition()}catch(e){console.error("error",e)}}get show(){return this.getVisible()}set show(e){this.setVisible(e)}setPosition(){if(!this.tileset)return;const e=this.tileset.boundingSphere.center,{translate:t,rotate:i,scale:n}=this.options.config,r=function(e,t,i,n){if(0===t&&0===i&&0===n)return;const r=h.Transforms.eastNorthUpToFixedFrame(e),o=new h.Cartesian3(t,i,n),s=h.Matrix4.multiplyByPoint(r,o,new h.Cartesian3),a=h.Cartesian3.subtract(s,e,new h.Cartesian3);return h.Matrix4.fromTranslation(a)}(e,...t),o=function(e,t,i,n){if(0===t&&0===i&&0===n)return;const r=h.Transforms.eastNorthUpToFixedFrame(e),o=h.Matrix4.inverse(r,new h.Matrix4),s=h.Matrix4.clone(h.Matrix4.IDENTITY);if(0!==t){const e=h.Matrix4.fromRotation(h.Matrix3.fromRotationX(h.Math.toRadians(t)));h.Matrix4.multiply(e,s,s)}if(0!==i){const e=h.Matrix4.fromRotation(h.Matrix3.fromRotationY(h.Math.toRadians(i)));h.Matrix4.multiply(e,s,s)}if(0!==n){const e=h.Matrix4.fromRotation(h.Matrix3.fromRotationZ(h.Math.toRadians(n)));h.Matrix4.multiply(e,s,s)}const a=h.Matrix4.multiply(s,o,new h.Matrix4);return h.Matrix4.multiply(r,a,new h.Matrix4)}(e,...i),s=function(e,t,i,n){if(t<=0||i<=0||n<=0)throw Error("缩放倍数必须大于0");if(1===t&&1===i&&1===n)return;const r=h.Transforms.eastNorthUpToFixedFrame(e),o=h.Matrix4.inverse(r,new h.Matrix4),s=h.Matrix4.fromScale(new h.Cartesian3(t,i,n)),a=h.Matrix4.multiply(s,o,new h.Matrix4);return h.Matrix4.multiply(r,a,new h.Matrix4)}(e,n,n,n);let a=this.tileset.modelMatrix;r&&(a=h.Matrix4.multiply(r,a,new h.Matrix4)),o&&(a=h.Matrix4.multiply(o,a,new h.Matrix4)),s&&(a=h.Matrix4.multiply(s,a,new h.Matrix4)),this.tileset.modelMatrix=a}flyTo(){this.options.config.visible&&this.tileset&&this.viewer.camera.flyToBoundingSphere(this.tileset.boundingSphere)}getVisible(){return this.tileset.show}setVisible(e){this.tileset.show=e}destroy(){super.destroy(),this.primitives.remove(this.tileset),this.tileset.destroy(),this.tileset=null}}const Ae={visible:!0,url:"./data/model/Horse.glb",height:0,position:[104.08761,30.602939],rotate:[0,0,0],scale:[1,1,1],color:"rgba(255,255,255,1)",distanceDisplay:[0,2e7],lighting:.5};class Te extends le{constructor(e,t){super(e,t),t.config=Object.assign({},Ae,t.config),this.model=null,this.addModel()}async addModel(){const e=this.viewer.scene,{url:t,visible:i,distanceDisplay:n,lighting:r,color:o}=this.options.config,s=this.getDistanceDisplayCondition(n),a=new h.ImageBasedLighting({imageBasedLightingFactor:new h.Cartesian2(r,r),luminanceAtZenith:.2}),l=this.getModelMatrix(this.options.config),c=h.Color.fromCssColorString(o),d=h.HeightReference.NONE,u={layer:this};try{this.model=this.primitives.add(await h.Model.fromGltfAsync({url:t,id:u,show:i,scene:e,modelMatrix:l,heightReference:d,imageBasedLighting:a,distanceDisplayCondition:s,color:c,ColorBlendMode:h.ColorBlendMode.MIX,colorBlendAmount:1,lightColor:new h.Cartesian3(1,1,1)}));this.model.getNode("NSBank")}catch(e){console.error("error",e)}}get show(){return this.getVisible()}set show(e){this.setVisible(e)}setPosition(){if(!this.model)return;const e=this.getModelMatrix(this.options.config);this.model.modelMatrix=e}getModelMatrix(e){const{position:t,scale:i,rotate:n,height:r}=e;return function(e,t,i,n){var r,o,s,a,l,c;const d=null!==(r=n[1])&&void 0!==r?r:0,u=null!==(o=n[0])&&void 0!==o?o:0,p=null!==(s=n[2])&&void 0!==s?s:0,m=null!==(a=i[0])&&void 0!==a?a:1,g=null!==(l=i[1])&&void 0!==l?l:1,f=null!==(c=i[2])&&void 0!==c?c:1,y=h.Cartesian3.fromDegrees(e[0]||0,e[1]||0,t||0),v=Math.PI,x=h.Transforms.headingPitchRollToFixedFrame(y,new h.HeadingPitchRoll(p/180*v,d/180*v,u/180*v)),w=h.Matrix4.fromScale(new h.Cartesian3(m,g,f));return h.Matrix4.multiply(x,w,x)}(t,r,i,n)}getDistanceDisplayCondition(e){return new h.DistanceDisplayCondition(parseFloat(e[0]),parseFloat(e[1]))}flyTo(){this.options.config.visible&&this.model&&this.viewer.camera.flyToBoundingSphere(this.model.boundingSphere)}getVisible(){return this.model.show}setVisible(e){this.model.show=e}destroy(){super.destroy(),this.primitives.remove(this.model),this.model.destroy(),this.model=null}}class Pe{constructor(){}static create(e,t){const i=[];let n=e.geometry;switch(n.type.toUpperCase()){case"LINESTRING":i.push(n.coordinates);break;case"MULTILINESTRING":for(let e=0,t=n.coordinates.length;e<t;e++)i.push(n.coordinates[e]);break;case"POLYGON":for(let e=0,t=n.coordinates.length;e<t;e++)i.push(n.coordinates[e]);break;case"MULTIPOLYGON":for(let e=0,t=n.coordinates.length;e<t;e++)for(let t=0,r=n.coordinates[e].length;t<r;t++)i.push(n.coordinates[e][t])}return this.createGeometry(i,t)}static createGeometry(e,t){const{extrudedHeight:i,height:n}=t,r=n+i;let o=[],s=[],a=[],l=null,c=0;for(let t=0;t<e.length;t++){const i=e[t];l=i[0];for(let e=1;e<i.length;e++){const t=h.Cartesian3.fromDegrees(l[0],l[1],n),d=h.Cartesian3.fromDegrees(l[0],l[1],r),u=h.Cartesian3.fromDegrees(i[e][0],i[e][1],n),p=h.Cartesian3.fromDegrees(i[e][0],i[e][1],r);o.push(t,d,u,p),s.push(0,0,0,1,1,0,1,1);const m=4*c;a.push(m+1,m,m+2,m+1,m+2,m+3),l=i[e],c++}}let d=new Float64Array(3*o.length);for(let e=0;e<o.length;e++)d[3*e]=o[e].x,d[3*e+1]=o[e].y,d[3*e+2]=o[e].z;return new h.Geometry({attributes:{position:this._createAttribute("DOUBLE",3,d),st:this._createAttribute("FLOAT",2,new Float32Array(s))},indices:new Uint16Array(a),primitiveType:h.PrimitiveType.TRIANGLES,boundingSphere:h.BoundingSphere.fromVertices(d)})}static _createAttribute(e,t,i){return new h.GeometryAttribute({componentDatatype:h.ComponentDatatype[e],componentsPerAttribute:t,values:i})}}const Se={visible:!0,height:{value:0,extrudedHeight:5e3},distanceDisplay:[0,2e7]},Ee={duration:5,lineCount:4,lineWidth:.1,color:[[0,"rgb(0,0,0)"],[1,"rgb(255,255,0)"]],lineColor:"rgba(0,255,0,1)"};class De extends le{constructor(e,t){super(e,t),this.type="fence",t.config=Object.assign({},Se,t.config),this.fencePrimitives=this.primitives.add(new h.PrimitiveCollection),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={fence:Object.assign({},Ee,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{fence:Object.assign({},Ee,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"lineString",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options;let i=[],{extrudedHeight:n,value:r}=t.config.height;const o=this.getDistanceDisplayCondition(t.config.distanceDisplay);for(let t=0,s=e.length;t<s;t++){const s=e[t],a=this.conditionFilter.dofilter(s),l=Pe.create(s,{height:r,extrudedHeight:n});i.push(l.boundingSphere);const c=new h.GeometryInstance({id:{feature:s,layer:this},geometry:l,attributes:{distanceDisplayCondition:o}}),d=new h.Primitive({geometryInstances:c,appearance:a.fence.appearance});this.fencePrimitives.add(d)}this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres(i)}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.fencePrimitives.show=e}getVisible(){return this.fencePrimitives.show}clearData(){super.clearData(),this.fencePrimitives.removeAll()}destroy(){super.destroy(),this.fencePrimitives.removeAll(),this.fencePrimitives.destroy(),this.primitives.remove(this.fencePrimitives),this.conditionFilter.destroy()}}function Le(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)+(e.z-t.z)*(e.z-t.z))}class Oe{constructor(){}static create(e,t){const i=[];let n=e.geometry;switch(n.type.toUpperCase()){case"LINESTRING":i.push(n.coordinates);break;case"MULTILINESTRING":for(let e=0,t=n.coordinates.length;e<t;e++)i.push(n.coordinates[e]);break;case"POLYGON":for(let e=0,t=n.coordinates.length;e<t;e++)i.push(n.coordinates[e]);break;case"MULTIPOLYGON":for(let e=0,t=n.coordinates.length;e<t;e++)for(let t=0,r=n.coordinates[e].length;t<r;t++)i.push(n.coordinates[e][t])}return this.createGeometry(i,t)}static createGeometry(e,t){const{extrudedHeight:i,height:n}=t,r=e[0].map((e=>h.Cartesian3.fromDegrees(e[0],e[1],0))),o=r.length-1;let s=new Float32Array(3*o*4),a=new Float32Array(3*o*4),l=new Float32Array(3*o*4),c=new Float32Array(2*o*4),d=new Float32Array(2*o*4),u=new Array;!function(e){let t=0,i=e[0];for(let n=1;n<e.length;n++)t+=Le(i,e[n]),i=e[n]}(r);let p=0,m=0;for(let e=0;e<o;e++){const t=[e,e+1];u.push(m),u.push(m+2),u.push(m+1),u.push(m+2),u.push(m+3),u.push(m+1),t.forEach((t=>{const i=m;d[2*i]=-1,d[2*i+1]=t===e?-1:1,d[2*i+2]=1,d[2*i+3]=t===e?-1:1;const n=r[t],h=r[0===t?t:t-1],u=r[t===o?t:t+1];c[2*i]=p,c[2*i+1]=0,c[2*i+2]=p,c[2*i+3]=1,e===t&&(p+=Le(n,u),console.log(Le(n,u))),s[3*i]=n.x,s[3*i+1]=n.y,s[3*i+2]=n.z,s[3*i+3]=n.x,s[3*i+4]=n.y,s[3*i+5]=n.z,a[3*i]=h.x,a[3*i+1]=h.y,a[3*i+2]=h.z,a[3*i+3]=h.x,a[3*i+4]=h.y,a[3*i+5]=h.z,l[3*i]=u.x,l[3*i+1]=u.y,l[3*i+2]=u.z,l[3*i+3]=u.x,l[3*i+4]=u.y,l[3*i+5]=u.z,m+=2}))}return new h.Geometry({attributes:{position:this._createAttribute("DOUBLE",3,s),prev:this._createAttribute("DOUBLE",3,a),next:this._createAttribute("DOUBLE",3,l),uv:this._createAttribute("FLOAT",2,c),side:this._createAttribute("FLOAT",2,d)},indices:new Uint16Array(u),primitiveType:h.PrimitiveType.TRIANGLES,boundingSphere:h.BoundingSphere.fromVertices(s)})}static _createAttribute(e,t,i){return new h.GeometryAttribute({componentDatatype:h.ComponentDatatype[e],componentsPerAttribute:t,values:i})}static addPosition(e,t,i){}}const Ie={visible:!0,height:{value:0,extrudedHeight:5e3},distanceDisplay:[0,2e7]},Re={width:12,color:"rgba(77,110,232,1)",outColor:"rgba(45,79,215,1)",imageUrl:"./images/arrow.png"};class Ne extends le{constructor(e,t){super(e,t),this.type="moveline",t.config=Object.assign({},Ie,t.config),this.linePrimitives=this.primitives.add(new h.PrimitiveCollection),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={moveline:Object.assign({},Re,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{moveline:Object.assign({},Re,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"lineString",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options;let{extrudedHeight:i,value:n}=t.config.height;const r=this.getDistanceDisplayCondition(t.config.distanceDisplay);for(let t=0,o=e.length;t<o;t++){const o=e[t],s=this.conditionFilter.dofilter(o),a=Oe.create(o,{height:n,extrudedHeight:i}),l=new h.GeometryInstance({id:{feature:o,layer:this},geometry:a,attributes:{distanceDisplayCondition:r}}),c=new h.Primitive({geometryInstances:l,appearance:s.moveline.appearance});this.linePrimitives.add(c)}this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres([])}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.linePrimitives.show=e}getVisible(){return this.linePrimitives.show}clearData(){super.clearData(),this.linePrimitives.removeAll()}destroy(){super.destroy(),this.linePrimitives.removeAll(),this.linePrimitives.destroy(),this.primitives.remove(this.linePrimitives),this.conditionFilter.destroy()}}function ze(e,t,i=2){const n=t&&t.length,r=n?t[0]*i:e.length;let o=Fe(e,0,r,i,!0);const s=[];if(!o||o.next===o.prev)return s;let a,l,h;if(n&&(o=function(e,t,i,n){const r=[];for(let i=0,o=t.length;i<o;i++){const s=Fe(e,t[i]*n,i<o-1?t[i+1]*n:e.length,n,!1);s===s.next&&(s.steiner=!0),r.push(Ye(s))}r.sort(We);for(let e=0;e<r.length;e++)i=je(r[e],i);return i}(e,t,o,i)),e.length>80*i){a=1/0,l=1/0;let t=-1/0,n=-1/0;for(let o=i;o<r;o+=i){const i=e[o],r=e[o+1];i<a&&(a=i),r<l&&(l=r),i>t&&(t=i),r>n&&(n=r)}h=Math.max(t-a,n-l),h=0!==h?32767/h:0}return ke(o,s,i,a,l,h,0),s}function Fe(e,t,i,n,r){let o;if(r===at(e,t,i,n)>0)for(let r=t;r<i;r+=n)o=rt(r/n|0,e[r],e[r+1],o);else for(let r=i-n;r>=t;r-=n)o=rt(r/n|0,e[r],e[r+1],o);return o&&Qe(o,o.next)&&(ot(o),o=o.next),o}function Be(e,t){if(!e)return e;t||(t=e);let i,n=e;do{if(i=!1,n.steiner||!Qe(n,n.next)&&0!==Ke(n.prev,n,n.next))n=n.next;else{if(ot(n),n=t=n.prev,n===n.next)break;i=!0}}while(i||n!==t);return t}function ke(e,t,i,n,r,o,s){if(!e)return;!s&&o&&function(e,t,i,n){let r=e;do{0===r.z&&(r.z=Ze(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,i=1;do{let n,r=e;e=null;let o=null;for(t=0;r;){t++;let s=r,a=0;for(let e=0;e<i&&(a++,s=s.nextZ,s);e++);let l=i;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||r.z<=s.z)?(n=r,r=r.nextZ,a--):(n=s,s=s.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;r=s}o.nextZ=null,i*=2}while(t>1)}(r)}(e,n,r,o);let a=e;for(;e.prev!==e.next;){const l=e.prev,h=e.next;if(o?He(e,n,r,o):Ge(e))t.push(l.i,e.i,h.i),ot(e),e=h.next,a=h.next;else if((e=h)===a){s?1===s?ke(e=Ve(Be(e),t),t,i,n,r,o,2):2===s&&Ue(e,t,i,n,r,o):ke(Be(e),t,i,n,r,o,1);break}}}function Ge(e){const t=e.prev,i=e,n=e.next;if(Ke(t,i,n)>=0)return!1;const r=t.x,o=i.x,s=n.x,a=t.y,l=i.y,h=n.y,c=r<o?r<s?r:s:o<s?o:s,d=a<l?a<h?a:h:l<h?l:h,u=r>o?r>s?r:s:o>s?o:s,p=a>l?a>h?a:h:l>h?l:h;let m=n.next;for(;m!==t;){if(m.x>=c&&m.x<=u&&m.y>=d&&m.y<=p&&$e(r,a,o,l,s,h,m.x,m.y)&&Ke(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function He(e,t,i,n){const r=e.prev,o=e,s=e.next;if(Ke(r,o,s)>=0)return!1;const a=r.x,l=o.x,h=s.x,c=r.y,d=o.y,u=s.y,p=a<l?a<h?a:h:l<h?l:h,m=c<d?c<u?c:u:d<u?d:u,g=a>l?a>h?a:h:l>h?l:h,f=c>d?c>u?c:u:d>u?d:u,y=Ze(p,m,t,i,n),v=Ze(g,f,t,i,n);let x=e.prevZ,w=e.nextZ;for(;x&&x.z>=y&&w&&w.z<=v;){if(x.x>=p&&x.x<=g&&x.y>=m&&x.y<=f&&x!==r&&x!==s&&$e(a,c,l,d,h,u,x.x,x.y)&&Ke(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,w.x>=p&&w.x<=g&&w.y>=m&&w.y<=f&&w!==r&&w!==s&&$e(a,c,l,d,h,u,w.x,w.y)&&Ke(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;x&&x.z>=y;){if(x.x>=p&&x.x<=g&&x.y>=m&&x.y<=f&&x!==r&&x!==s&&$e(a,c,l,d,h,u,x.x,x.y)&&Ke(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;w&&w.z<=v;){if(w.x>=p&&w.x<=g&&w.y>=m&&w.y<=f&&w!==r&&w!==s&&$e(a,c,l,d,h,u,w.x,w.y)&&Ke(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function Ve(e,t){let i=e;do{const n=i.prev,r=i.next.next;!Qe(n,r)&&Je(n,i,i.next,r)&&it(n,r)&&it(r,n)&&(t.push(n.i,i.i,r.i),ot(i),ot(i.next),i=e=r),i=i.next}while(i!==e);return Be(i)}function Ue(e,t,i,n,r,o){let s=e;do{let e=s.next.next;for(;e!==s.prev;){if(s.i!==e.i&&Xe(s,e)){let a=nt(s,e);return s=Be(s,s.next),a=Be(a,a.next),ke(s,t,i,n,r,o,0),void ke(a,t,i,n,r,o,0)}e=e.next}s=s.next}while(s!==e)}function We(e,t){return e.x-t.x}function je(e,t){const i=function(e,t){let i=t;const n=e.x,r=e.y;let o,s=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const e=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>s&&(s=e,o=i.x<i.next.x?i:i.next,e===n))return o}i=i.next}while(i!==t);if(!o)return null;const a=o,l=o.x,h=o.y;let c=1/0;i=o;do{if(n>=i.x&&i.x>=l&&n!==i.x&&$e(r<h?n:s,r,l,h,r<h?s:n,r,i.x,i.y)){const t=Math.abs(r-i.y)/(n-i.x);it(i,e)&&(t<c||t===c&&(i.x>o.x||i.x===o.x&&qe(o,i)))&&(o=i,c=t)}i=i.next}while(i!==a);return o}(e,t);if(!i)return t;const n=nt(i,e);return Be(n,n.next),Be(i,i.next)}function qe(e,t){return Ke(e.prev,e,t.prev)<0&&Ke(t.next,e,e.next)<0}function Ze(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Ye(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function $e(e,t,i,n,r,o,s,a){return(r-s)*(t-a)>=(e-s)*(o-a)&&(e-s)*(n-a)>=(i-s)*(t-a)&&(i-s)*(o-a)>=(r-s)*(n-a)}function Xe(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Je(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(it(e,t)&&it(t,e)&&function(e,t){let i=e,n=!1;const r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)&&(Ke(e.prev,e,t.prev)||Ke(e,t.prev,t))||Qe(e,t)&&Ke(e.prev,e,e.next)>0&&Ke(t.prev,t,t.next)>0)}function Ke(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function Qe(e,t){return e.x===t.x&&e.y===t.y}function Je(e,t,i,n){const r=tt(Ke(e,t,i)),o=tt(Ke(e,t,n)),s=tt(Ke(i,n,e)),a=tt(Ke(i,n,t));return r!==o&&s!==a||(!(0!==r||!et(e,i,t))||(!(0!==o||!et(e,n,t))||(!(0!==s||!et(i,e,n))||!(0!==a||!et(i,t,n)))))}function et(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function tt(e){return e>0?1:e<0?-1:0}function it(e,t){return Ke(e.prev,e,e.next)<0?Ke(e,t,e.next)>=0&&Ke(e,e.prev,t)>=0:Ke(e,t,e.prev)<0||Ke(e,e.next,t)<0}function nt(e,t){const i=st(e.i,e.x,e.y),n=st(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function rt(e,t,i,n){const r=st(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function ot(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function st(e,t,i){return{i:e,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function at(e,t,i,n){let r=0;for(let o=t,s=i-n;o<i;o+=n)r+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return r}function lt(e){const t=[],i=[],n=e[0][0].length;let r=0,o=0;for(const s of e){for(const e of s)for(let i=0;i<n;i++)t.push(e[i]);o&&(r+=o,i.push(r)),o=s.length}return{vertices:t,holes:i,dimensions:n}}class ht{constructor(){}static create(e,t,i){const n=[],r=[];let o=e.geometry;switch(o.type.toUpperCase()){case"POLYGON":n.push(this.createTopGeometry(o.coordinates,t,i));for(let e=0,i=o.coordinates.length;e<i;e++)r.push(this.createSideGeometry(o.coordinates[e],t));break;case"MULTIPOLYGON":for(let e=0,s=o.coordinates.length;e<s;e++){n.push(this.createTopGeometry(o.coordinates[e],t,i));for(let i=0,n=o.coordinates[e].length;i<n;i++)r.push(this.createSideGeometry(o.coordinates[e][i],t))}}return{topGeometries:n,sideGeometries:r}}static createSideGeometry(e,t){const{extrudedHeight:i,height:n}=t,r=n+i,o=e.length,s=new Float32Array(3*o*2),a=new Float32Array(3*o*2),l=new Float32Array(2*o*2),c=new Array;let d=0;for(let t=0;t<o;t++){const i=2*t;i>0&&(d+=h.Cartesian3.distance(h.Cartesian3.fromDegrees(e[t][0],e[t][1],0),h.Cartesian3.fromDegrees(e[t-1][0],e[t-1][1],0)));for(let o=0;o<2;o++){const c=o+i,u=h.Cartesian3.fromDegrees(e[t][0],e[t][1],0==o?n:r),p=h.EncodedCartesian3.fromCartesian(u);s[3*c]=p.high.x,s[3*c+1]=p.high.y,s[3*c+2]=p.high.z,a[3*c]=p.low.x,a[3*c+1]=p.low.y,a[3*c+2]=p.low.z,l[2*c]=d/r,l[2*c+1]=o}}for(let e=0;e<2*(o-1);e+=2)c.push(e),c.push(e+1),c.push(e+2),c.push(e+2),c.push(e+1),c.push(e+3);return{bufferDatas:{position3DHigh:{offset:3,data:s},position3DLow:{offset:3,data:a},uv:{offset:2,data:l},indexs:new Uint32Array(c)},attributeLocations:{position3DHigh:0,position3DLow:1,uv:2}}}static createTopGeometry(e,t,i){const{extrudedHeight:n,height:r}=t,o=r+n,s=lt(e),a=ze(s.vertices,s.holes,s.dimensions),l=s.vertices.length/s.dimensions,c=new Float32Array(3*l),d=new Float32Array(3*l);for(let e=0;e<l;e++){const t=2*e,n=h.Cartesian3.fromDegrees(s.vertices[t],s.vertices[t+1],o);i.push(n);const r=h.EncodedCartesian3.fromCartesian(n);c[3*e]=r.high.x,c[3*e+1]=r.high.y,c[3*e+2]=r.high.z,d[3*e]=r.low.x,d[3*e+1]=r.low.y,d[3*e+2]=r.low.z}return{bufferDatas:{position3DHigh:{offset:3,data:c},position3DLow:{offset:3,data:d},indexs:new Uint32Array(a)},attributeLocations:{position3DHigh:0,position3DLow:1}}}static _createAttribute(e,t,i){return new h.GeometryAttribute({componentDatatype:h.ComponentDatatype[e],componentsPerAttribute:t,values:i})}static addPosition(e,t,i){}}var ct=function(){var e=document.createElement("canvas");e.width=64,e.height=64;var t=e.getContext("2d");return t.fillStyle="rgba(0,0,0,0)",t.fillRect(0,0,256,256),e}();h.ComponentDatatype.getSizeInBytes(h.ComponentDatatype.FLOAT);class dt{constructor(e,t,i,n){this.context=e,this.boundingSphere=n,this.modelMatrix=t.modelMatrix||h.Matrix4.IDENTITY.clone(),this._attributeLocations=t.attributeLocations,this.visible=!0,this.vertexArray=null,this.program=null,this.uniformMap=i,this.primitiveType=h.PrimitiveType.TRIANGLES,this.renderState=this.createRenderState(),this.pass=h.Pass.TRANSLUCENT}_init(e){this.createProgram&&this.createProgram(),this.createVertexArray&&this.createVertexArray(e)}getAttributeLocations(){return this._attributeLocations}_init(e){this.createProgram&&this.createProgram(),this.createVertexArray&&this.createVertexArray(e),this.createUniformMap&&this.createUniformMap()}createVertexArray(e){const t=this.getAttributeLocations(),i=[];for(let n in t){const r=e[n],o=this.createBuffer(r.data),s=this.createAttribute(o,t[n],r.offset);i.push(s)}const n=h.Buffer.createIndexBuffer({context:this.context,typedArray:e.indexs,usage:h.BufferUsage.STATIC_DRAW,indexDatatype:h.IndexDatatype.UNSIGNED_INT});this.vertexArray=new h.VertexArray({context:this.context,indexBuffer:n,attributes:i})}loadImageAsync(e){return new Promise(((t,i)=>{h.Resource.createIfNeeded(e).fetchImage().then((e=>{const i=document.createElement("canvas"),{width:n,height:r}=e,o=Math.max(n,r),s=!isPowerOfTwo(o)?ceilPowerOfTwo(o):o;i.width=s,i.height=s;const a=i.getContext("2d");null==a||a.drawImage(e,(s-n)/2,(s-r)/2),t(this.createTexture(i))}))}))}getAttributeLocations(){return this._attributeLocations}createTransTexture(){return this.createTexture(ct)}createTexture(e){return new h.Texture({context:this.context,width:e.width,height:e.height,flipY:!1,sampler:new Sampler({wrapS:h.WebGLConstants.REPEAT}),source:e,hasMipmap:!1,pixelDatatype:h.PixelDatatype.UNSIGNED_BYTE})}createProgram(){this.program=h.ShaderProgram.fromCache({context:this.context,vertexShaderSource:shaderVS,fragmentShaderSource:shaderFS,attributeLocations:this.getAttributeLocations()})}createRenderState(e=!0,t=!1){return h.RenderState.fromCache({cull:{enabled:!0,face:h.CullFace.BACK},depthTest:{enabled:!0,func:h.DepthFunction.LESS}})}createAttribute(e,t,i){return{index:t,vertexBuffer:e,componentsPerAttribute:i,componentDatatype:h.ComponentDatatype.FLOAT,normalize:!1}}createBuffer(e){return h.Buffer.createVertexBuffer({context:this.context,typedArray:e,usage:h.BufferUsage.STATIC_DRAW})}update(e){if(!this.visible)return;const t=new h.DrawCommand({modelMatrix:this.modelMatrix,boundingVolume:this.boundingSphere,primitiveType:this.primitiveType,vertexArray:this.vertexArray,shaderProgram:this.program,uniformMap:this.uniformMap,renderState:this.renderState,pass:this.pass});e.commandList.push(t)}isDestroyed(){}destroy(){this.boundingSphere=null,this.modelMatrix=null,this._attributeLocations=null,this.vertexArray=null,this.program=null,this.uniformMap=null,this.primitiveType=null,this.renderState=null,this.pass=null}}class ut extends dt{constructor(e,t,i,n){super(e,t,i,n),this._init(t.bufferDatas)}createProgram(){this.program=h.ShaderProgram.fromCache({context:this.context,vertexShaderSource:"\n\nin vec3 position3DHigh;\nin vec3 position3DLow;\n\nvec4 computePosition(vec3 high , vec3 low){\n    return czm_translateRelativeToEye(high,low);\n}\nvoid main(){\n    //有精度丢失情况\n    // vec3 position = position3DHigh+position3DLow;\n    // gl_Position = czm_projection  * czm_modelView * vec4( position , 1. );\n\n    vec4 p = computePosition(position3DHigh , position3DLow);\n    vec3 positionEC = (czm_modelViewRelativeToEye * p).xyz;//世界坐标\n    vec4 positionMC = czm_inverseModelView  * vec4(positionEC, 1.0);//模型坐标\n    \n    //使用屏幕坐标\n    // vec4 positionWC = czm_eyeToWindowCoordinates(vec4(positionEC, 1.0));\n    // vec4 newPositionWC = vec4(positionWC.x, positionWC.y, -positionWC.z, 1.0)*(czm_projection * vec4(positionEC, 1.0)).w;\n    // gl_Position = czm_viewportOrthographic * newPositionWC;\n\n    gl_Position = czm_modelViewProjectionRelativeToEye * p;\n\n    //这两个相同，都会有精度丢失\n    //gl_Position =  czm_projection  * czm_view * positionMC;\n    //gl_Position = czm_modelViewInfiniteProjection * positionMC;\n}\n",fragmentShaderSource:"\n\nuniform vec4 u_color;\nvoid main(){\n    out_FragColor=vec4( u_color);\n}\n",attributeLocations:this.getAttributeLocations()})}isDestroyed(){}}class pt extends dt{constructor(e,t,i,n){super(e,t,i,n),this._init(t.bufferDatas)}createProgram(){this.program=h.ShaderProgram.fromCache({context:this.context,vertexShaderSource:"\n\nin vec3 position3DHigh;\nin vec3 position3DLow;\nin vec2 uv;\n\nout vec2 v_uv;\n\nvec4 computePosition(vec3 high , vec3 low){\n    return czm_translateRelativeToEye(high,low);\n}\nvoid main(){\n   \n    vec4 p = computePosition(position3DHigh , position3DLow);\n    vec3 positionEC = (czm_modelViewRelativeToEye * p).xyz;//世界坐标\n    vec4 positionMC = czm_inverseModelView  * vec4(positionEC, 1.0);//模型坐标\n    v_uv = uv;\n    gl_Position = czm_modelViewProjectionRelativeToEye * p;\n}\n",fragmentShaderSource:"\n\nin vec2 v_uv;\nuniform vec4 u_color;\nuniform vec4 u_lineColor;\n\nfloat attenuation(float d)\n{ \n    float Kc = 0.25;\n    float Kl = 0.1;\n    float Kq = 0.001;\n    return 1.0 / (Kc + Kl*d + Kq*d*d);\n}\n\nvoid main(){\n    vec4 color = u_color;\n    \n\n    if(v_uv.t>0.9){\n        color = u_lineColor;\n    }else{\n        color.a *= clamp(v_uv.t,0.35,0.8);\n    }\n    out_FragColor=color;\n}\n",attributeLocations:this.getAttributeLocations()})}}const mt={visible:!0,height:{extrudedHeight:0,value:0}},gt={topColor:"rgba(46, 132, 110, .6)",sideColor:"rgba(46, 132, 110, .6)",lineColor:"rgba(199, 210, 197 , 1.0)"};class ft extends le{constructor(e,t){super(e,t),this.type="svgpolygon",t.config=Object.assign({},mt,t.config),this.polygons=this.primitives.add(new h.PrimitiveCollection),this.conditionFilter=new ae,this.createConditionStyle(t),this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}createConditionStyle(e){const t={svg:Object.assign({},gt,e.style)},i=[],n=e.conditionStyle;n&&n.forEach((e=>{i.push({condition:e.condition,style:{svg:Object.assign({},gt,e.style)}})})),this.conditionFilter.update(t,i)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"polygon",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features;if(this.clearData(),!e||0==e.length)return;const t=this.options;let{value:i,extrudedHeight:n}=t.config.height;for(let t=0,r=e.length;t<r;t++){const r=e[t],o=this.conditionFilter.dofilter(r),s=[],{top:a,side:l}=o.svg,c=ht.create(r,{height:i,extrudedHeight:n},s),d=h.BoundingSphere.fromPoints(s);c.topGeometries.forEach((e=>{const t=new ut(this.viewer.scene.context,e,a,d);this.polygons.add(t)})),c.sideGeometries.forEach((e=>{const t=new pt(this.viewer.scene.context,e,l,d);this.polygons.add(t)}))}this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres([])}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.polygons.show=e}getVisible(){return this.polygons.show}clearData(){super.clearData(),this.polygons.removeAll()}destroy(){super.destroy(),this.polygons.removeAll(),this.polygons.destroy(),this.primitives.remove(this.polygons),this.conditionFilter.destroy()}}const yt=new h.GeographicProjection,vt=yt.ellipsoid,xt=new h.Cartesian3,wt=new h.Cartographic;class Ct{constructor(){this.pointLength=0,this.highArrays=[],this.lowArrays=[],this.indexs=[],this.colors=[],this.uvs=[],this.boundingSpheres=[]}create(e,t){let i=e.geometry;switch(i.type.toUpperCase()){case"POLYGON":this.createTopGeometry(i.coordinates,t);for(let e=0,n=i.coordinates.length;e<n;e++)this.createSideGeometry(i.coordinates[e],t);break;case"MULTIPOLYGON":for(let e=0,n=i.coordinates.length;e<n;e++){this.createTopGeometry(i.coordinates[e],t);for(let n=0,r=i.coordinates[e].length;n<r;n++)this.createSideGeometry(i.coordinates[e][n],t)}}}createSideGeometry(e,t){const{extrudedHeight:i,height:n,color:r}=t,o=n+i;if(0==i)return;let{highArrays:s,lowArrays:a,indexs:l,pointLength:c,colors:d,uvs:u}=this;const p=e.length,m=new h.Color.fromCssColorString(r);let g=0;for(let t=0;t<p;t++){t>0&&(g+=h.Cartesian3.distance(h.Cartesian3.fromDegrees(e[t][0],e[t][1],0),h.Cartesian3.fromDegrees(e[t-1][0],e[t-1][1],0)));for(let i=0;i<2;i++){const r=h.Cartesian3.fromDegrees(e[t][0],e[t][1],0==i?n:o),l=vt.cartesianToCartographic(r,wt),c=yt.project(l,xt),p=h.EncodedCartesian3.fromCartesian(c);s.push(p.high.x,p.high.y,p.high.z),a.push(p.low.x,p.low.y,p.low.z),d.push(m.red,m.green,m.blue),u.push(g/o,i,0)}}const f=c;for(let e=0;e<2*(p-1);e+=2)l.push(f+e),l.push(f+e+1),l.push(f+e+2),l.push(f+e+2),l.push(f+e+1),l.push(f+e+3);this.pointLength+=2*p}createTopGeometry(e,t){const{extrudedHeight:i,height:n,color:r}=t,o=n+i,s=lt(e),a=new h.Color.fromCssColorString(r),{highArrays:l,lowArrays:c,indexs:d,pointLength:u,colors:p,uvs:m}=this,g=ze(s.vertices,s.holes,s.dimensions),f=s.vertices.length/s.dimensions;for(let e=0;e<f;e++){const t=2*e,i=h.Cartesian3.fromDegrees(s.vertices[t],s.vertices[t+1],o),n=vt.cartesianToCartographic(i,wt),r=yt.project(n,xt);this.boundingSpheres.push(r);const d=h.EncodedCartesian3.fromCartesian(r);l.push(d.high.x,d.high.y,d.high.z),c.push(d.low.x,d.low.y,d.low.z),p.push(a.red,a.green,a.blue),m.push(1,1,1)}const y=u;for(let e=0;e<g.length;e++)d.push(y+g[e]);this.pointLength+=f}_createAttribute(e,t,i){return new h.GeometryAttribute({componentDatatype:h.ComponentDatatype[e],componentsPerAttribute:t,values:i})}destroy(){this.highArrays.length=0,this.indexs.length=0,this.lowArrays.length=0,this.boundingSpheres.length=0,this.colors.length=0,this.uvs.length=0}}class _t extends dt{constructor(e,t,i,n){super(e,t,i,n),this._init(t.bufferDatas),this.pass=h.Pass.TRANSLUCENT}createRenderState(e=!0,t=!1){return h.RenderState.fromCache({cull:{enabled:!1,face:h.CullFace.BACK},depthTest:{enabled:!0,func:h.WebGLConstants.LESS},depthMask:!0,sampleCoverage:{enabled:!0,value:1,invert:!1}})}createProgram(){this.program=h.ShaderProgram.fromCache({context:this.context,vertexShaderSource:"\n\nin vec3 position3DHigh;\nin vec3 position3DLow;\nin vec3 a_color;\nin vec3 a_uv;\n\nout vec3 v_color;\nout vec3 v_uv;\n\nvec4 computePosition(vec3 high , vec3 low){\n    return czm_translateRelativeToEye(high,low);\n}\nvoid main(){\n    vec4 p = computePosition(position3DHigh.zxy , position3DLow.zxy);\n    vec3 positionEC = (czm_modelViewRelativeToEye * p).xyz;//世界坐标\n    vec4 positionMC = czm_inverseModelView  * vec4(positionEC, 1.0);//模型坐标\n    v_color = a_color;\n    v_uv = a_uv;\n    gl_Position = czm_modelViewProjectionRelativeToEye * p;\n}\n",fragmentShaderSource:"\n\nin vec3 v_color;\nin vec3 v_uv;\nvoid main(){\n    vec3 color = v_color;\n    float alph = 0.8;\n    if(v_uv.b <0.5){\n        alph = 0.7;\n    }\n    out_FragColor=czm_gammaCorrect(vec4( color,alph));\n}\n",attributeLocations:this.getAttributeLocations()})}isDestroyed(){}}const bt={config:{visible:!0,height:{extrudedHeight:200,value:465},color:{value:"",field:"",transparent:1}}};class Mt extends le{constructor(e,t){super(e,t),this.type="planning",t.config=Object.assign({},bt,t.config),this.polygons=this.primitives.add(new h.PrimitiveCollection),this.planningGeometry=new Ct,this.setVisible(t.config.visible),this.queryData()}get show(){this.getVisible()}set show(e){this.setVisible(e)}queryData(){if(!this.source.dataLoaded)return;const e={dataType:"polygon",filter:this.options.filter};this.source.queryData(e,(e=>{"success"===e.msgType&&(this._features=e.features,this.updateFeatures())}))}updateFeatures(){const e=this._features,t=this.planningGeometry;if(this.clearData(),!e||0==e.length)return;const i=this.options;let{value:n,extrudedHeight:r}=i.config.height,{value:o,field:s,transparent:a=1}=i.config.color;for(let i=0,l=e.length;i<l;i++){const l=e[i],h=l.properties;let c="rgba(255,0,0,1.0)";s&&h[s]?c=`rgba(${h[s]},${a})`:o&&(c=o),t.create(l,{height:n,extrudedHeight:r,color:c})}const l={u_color:()=>new h.Color.fromCssColorString("rgba(255,0,0,1)"),u_transparent:a},c={bufferDatas:{position3DHigh:{offset:3,data:new Float32Array(t.highArrays)},position3DLow:{offset:3,data:new Float32Array(t.lowArrays)},a_color:{offset:3,data:new Float32Array(t.colors)},a_uv:{offset:3,data:new Float32Array(t.uvs)},indexs:new Uint32Array(t.indexs)},attributeLocations:{position3DHigh:0,position3DLow:1,a_color:2,a_uv:3}},d=new _t(this.viewer.scene.context,c,l);this.polygons.add(d),this._boundingSpheres=h.BoundingSphere.fromBoundingSpheres([])}getDistanceDisplayCondition(e){const t=parseFloat(e[0]),i=parseFloat(e[1]);return new h.DistanceDisplayConditionGeometryInstanceAttribute(t,i)}setVisible(e){this.polygons.show=e}getVisible(){return this.polygons.show}clearData(){super.clearData(),this.polygons.removeAll()}destroy(){super.destroy(),this.polygons.removeAll(),this.polygons.destroy(),this.primitives.remove(this.polygons),this.planningGeometry.destroy(),this.planningGeometry=null}}class At extends P{constructor(e){super(e)}add(e){const t=e.id;let i=this.get(t);if(!i)return i=new l[e.type](this.mapInstance,e),this.collection.push(i),i;console.error("存在相同id")}}class Tt{constructor(e,t,i){this.target=e,this.parent=t,this.callbacks={},this.mapId=i,this.target.addEventListener("message",this.receive.bind(this),!1)}send(e,t,i){const n=Math.round(1e18*Math.random()).toString(36).substring(0,10);i&&(this.callbacks[n]=i),this.target.postMessage({id:n,type:e,args:t,sourceMapId:this.mapId,hasCallback:!!i})}receive(e){if(!e.data||!e.data.type)return;e.data.type;const t=e.data.id,i=this.callbacks[t];delete this.callbacks[t],i&&i(e.data.data)}remove(){this.target.removeEventListener("message",this.receive,!1)}}let Pt=1;class St{constructor(e,t){this.parent=t,this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Pt++;const i=this.workerPool.acquire(this.id);for(let e=0;e<i.length;e++){const t=i[e],n=new Tt(t,this.parent,this.id);n.name=`Worker ${e}`,this.actors.push(n)}}broadcast(e,t,i){i=i||function(){},function(e,t,i){if(!e.length)return i(void 0,[]);let n=e.length;const r=new Array(e.length);let o;e.forEach(((e,s)=>{t(e,((e,t)=>{e&&(o=e),r[s]=t,0==--n&&i(o,r)}))}))}(this.actors,((i,n)=>{i.send(e,t,n)}),i)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.realse(this.id)}}var Et=n(512),Dt=n.n(Et);function Lt(){return Dt()('(()=>{"use strict";var t={d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function n(t,e){this.x=t,this.y=e}t.r(e),t.d(e,{clear_geojson:()=>N,load_geojson:()=>T,query_geojson:()=>x}),n.prototype={clone(){return new n(this.x,this.y)},add(t){return this.clone()._add(t)},sub(t){return this.clone()._sub(t)},multByPoint(t){return this.clone()._multByPoint(t)},divByPoint(t){return this.clone()._divByPoint(t)},mult(t){return this.clone()._mult(t)},div(t){return this.clone()._div(t)},rotate(t){return this.clone()._rotate(t)},rotateAround(t,e){return this.clone()._rotateAround(t,e)},matMult(t){return this.clone()._matMult(t)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(t){return this.x===t.x&&this.y===t.y},dist(t){return Math.sqrt(this.distSqr(t))},distSqr(t){const e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle(){return Math.atan2(this.y,this.x)},angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith(t){return this.angleWithSep(t.x,t.y)},angleWithSep(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult(t){const e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},_add(t){return this.x+=t.x,this.y+=t.y,this},_sub(t){return this.x-=t.x,this.y-=t.y,this},_mult(t){return this.x*=t,this.y*=t,this},_div(t){return this.x/=t,this.y/=t,this},_multByPoint(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint(t){return this.x/=t.x,this.y/=t.y,this},_unit(){return this._div(this.mag()),this},_perp(){const t=this.y;return this.y=this.x,this.x=-t,this},_rotate(t){const e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,s=n*this.x+e*this.y;return this.x=r,this.y=s,this},_rotateAround(t,e){const n=Math.cos(t),r=Math.sin(t),s=e.x+n*(this.x-e.x)-r*(this.y-e.y),o=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=s,this.y=o,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:n},n.convert=function(t){if(t instanceof n)return t;if(Array.isArray(t))return new n(+t[0],+t[1]);if(void 0!==t.x&&void 0!==t.y)return new n(+t.x,+t.y);throw new Error("Expected [x, y] or {x, y} point format")};class r{constructor(t,e,n,r,o){this.properties={},this.extent=n,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=r,this._values=o,t.readFields(s,this,e)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos,r=[];let s,o=1,i=0,u=0,a=0;for(;t.pos<e;){if(i<=0){const e=t.readVarint();o=7&e,i=e>>3}if(i--,1===o||2===o)u+=t.readSVarint(),a+=t.readSVarint(),1===o&&(s&&r.push(s),s=[]),s&&s.push(new n(u,a));else{if(7!==o)throw new Error(`unknown command ${o}`);s&&s.push(s[0].clone())}}return s&&r.push(s),r}bbox(){const t=this._pbf;t.pos=this._geometry;const e=t.readVarint()+t.pos;let n=1,r=0,s=0,o=0,i=1/0,u=-1/0,a=1/0,h=-1/0;for(;t.pos<e;){if(r<=0){const e=t.readVarint();n=7&e,r=e>>3}if(r--,1===n||2===n)s+=t.readSVarint(),o+=t.readSVarint(),s<i&&(i=s),s>u&&(u=s),o<a&&(a=o),o>h&&(h=o);else if(7!==n)throw new Error(`unknown command ${n}`)}return[i,a,u,h]}toGeoJSON(t,e,n){const r=this.extent*Math.pow(2,n),s=this.extent*t,i=this.extent*e,u=this.loadGeometry();function a(t){return[360*(t.x+s)/r-180,360/Math.PI*Math.atan(Math.exp((1-2*(t.y+i)/r)*Math.PI))-90]}function h(t){return t.map(a)}let c;if(1===this.type){const t=[];for(const e of u)t.push(e[0]);const e=h(t);c=1===t.length?{type:"Point",coordinates:e[0]}:{type:"MultiPoint",coordinates:e}}else if(2===this.type){const t=u.map(h);c=1===t.length?{type:"LineString",coordinates:t[0]}:{type:"MultiLineString",coordinates:t}}else{if(3!==this.type)throw new Error("unknown feature type");{const t=function(t){const e=t.length;if(e<=1)return[t];const n=[];let r,s;for(let i=0;i<e;i++){const e=o(t[i]);0!==e&&(void 0===s&&(s=e<0),s===e<0?(r&&n.push(r),r=[t[i]]):r&&r.push(t[i]))}r&&n.push(r);return n}(u),e=[];for(const n of t)e.push(n.map(h));c=1===e.length?{type:"Polygon",coordinates:e[0]}:{type:"MultiPolygon",coordinates:e}}}const l={type:"Feature",geometry:c,properties:this.properties};return null!=this.id&&(l.id=this.id),l}}function s(t,e,n){1===t?e.id=n.readVarint():2===t?function(t,e){const n=t.readVarint()+t.pos;for(;t.pos<n;){const n=e._keys[t.readVarint()],r=e._values[t.readVarint()];e.properties[n]=r}}(n,e):3===t?e.type=n.readVarint():4===t&&(e._geometry=n.pos)}function o(t){let e=0;for(let n,r,s=0,o=t.length,i=o-1;s<o;i=s++)n=t[s],r=t[i],e+=(r.x-n.x)*(n.y+r.y);return e}r.types=["Unknown","Point","LineString","Polygon"];"undefined"==typeof TextDecoder||new TextDecoder("utf-8");const i={};const u={EQUAL:function(t,e){return t==e},NO_EQUAL:function(t,e){return t!=e},GREATER_THAN:function(t,e){return t>e},GREATER_THAN_E:function(t,e){return t>=e},LESS_THAN:function(t,e){return t<e},LESS_THAN_E:function(t,e){return t<=e},LIKE:function(t,e){return t&&-1!==t.indexOf(e)},NOT_LIKE:function(t,e){return t&&-1===t.indexOf(e)},L_LIKE:function(t,e){return t&&0===t.indexOf(e)},L_NOT_LIKE:function(t,e){return t&&0!==t.indexOf(e)},R_LIKE:function(t,e){return t&&t.length===e.length+t.lastIndexOf(e)},R_NOT_LIKE:function(t,e){return t&&t.length!==e.length+t.lastIndexOf(e)},IN:function(t,e){return e.includes(t)},NOT_IN:function(t,e){return!e.includes(t)},IS_NULL:function(t){return null===t},IS_NOT_NULL:function(t){return null!==t},IS_EMPTY:function(t){return""===t},IS_NOT_EMPTY:function(t){return""!==t}};function a(t,e){const{expressions:n,relation:r}=t;if(Array.isArray(n)&&n.length>0){let t=!1,s=0;for(let r=n.length,o=0;o<r;o++){const r=n[o];r&&(t=r.operator?u[r.operator](e[r.left.asColumnName],r.right.queryExpression.values[0]):a(r,e),t&&(s+=1))}let o=!1;switch(r){case"AND":default:o=n.length===s;break;case"OR":o=s>0}return o}return!1}function h(t,e){return!!e&&a(e,t.properties)}const c=["AND","OR"],l={"==":"EQUAL","!=":"NO_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_E","<":"LESS_THAN","<=":"LESS_THAN_E"};class p{constructor(t,e){if(this.relation="AND",this.expressions=[],c.includes(t[0])){this.relation=t[0];for(let e=1;e<t.length;e++)this.expressions.push(this.create(t[e]))}else this.expressions.push(this.create(t));this.style=e}create(t){return t.length<3||t.length>4?null:{operator:l[t[1]],left:{asColumnName:t[0]},right:{queryExpression:{dataType:"string",values:[t[2]]}}}}}const y={POINT:"Point",LINESTRING:"LineString",POLYGON:"Polygon"};function d(t,e,n=[]){return{type:"Feature",properties:e,geometry:{type:t,coordinates:n}}}function f(t,e,n){let r=0;return r=t[0]*e[1]+e[0]*n[1]+n[0]*t[1]-e[0]*t[1]-n[0]*e[1]-t[0]*n[1],r/2}function g(t){let e,n=0,r=0,s=0,o=t[1];for(let i=2;i<t.length;i++){e=t[i];const u=f(t[0],o,e);s+=u,n+=(t[0][0]+o[0]+e[0])*u,r+=(t[0][1]+o[1]+e[1])*u,o=e}return[n/s/3,r/s/3]}const _={};function x(t,e){const{sourceId:n,data:r}=t.args,s=_[n];if(!s)return void e({msgType:"failed"});e({msgType:"success",features:function(t,e){const{filter:n,dataType:r}=e;let s=[],o=t;if(n){const e=new p(n);o=t.filter((t=>h(t,e)))}return function(t,e,n){t.forEach((t=>{const r=t.geometry.type.toUpperCase(),s=e.toUpperCase();switch(r){case"POINT":case"MULTIPOINT":"POINT"==s&&n.push(t);break;case"LINESTRING":case"MULTILINESTRING":"LINESTRING"==s?n.push(t):"LINESTRING"==s&&n.push(function(t){const e=g("LINESTRING"===t.geometry.type.toUpperCase()?t.geometry.coordinates:t.geometry.coordinates[0]);return d(y.POINT,t.properties,e)}(t));break;case"POLYGON":case"MULTIPOLYGON":"POLYGON"==s||"LINESTRING"==s?n.push(t):"POINT"==s&&n.push(function(t){const e=g("POLYGON"===t.geometry.type.toUpperCase()?t.geometry.coordinates[0]:t.geometry.coordinates[0][0]);return d(y.POINT,t.properties,e)}(t))}}))}(o,r,s),console.log(s.length),s}(s.features,r)})}function T(t,e){const{args:n}=t,{sourceId:r,data:s}=n;"string"==typeof s?function(t,e,n){const r=globalThis.location;let s=new AbortController;if(r.protocol&&("http:"===r.protocol||"https:"===r.protocol||"blob:"===r.protocol)){const r=new Headers;r.append("Content-Type","application/json");const o={headers:r,method:"GET",referrer:e.origin||"",signal:s.signal};e.uri.startsWith(e.origin)&&(o.credentials="include"),i[t]=s,fetch(e.uri,o).then((function(t){return 401===t.status?n(null,null,new Error("Invalid Token")):200!==t.status?n(null,null,new Error("Error retrieving data from %s. Server responded with code: %s")):t.json()})).then((function(e){delete i[t],n(e)})).catch((e=>(delete i[t],n(null,null,new Error(`Error:${e}`)))))}}(r,{uri:s},(t=>{_[r]=t,e({msgType:"success"})})):(_[r]=s,e({msgType:"success"}))}function N(t,e){const{args:n}=t,{sourceId:r}=n;let s="failed";var o;_[r]?(s="success",delete _[r]):i[o=r]&&(i[o].abort(),delete i[o],1)&&(s="success"),e({msgType:s})}self.addEventListener("message",(t=>{let n=t.data;if(!n||!n.type)return;const r=n.type,s=n.id,o=n.sourceMapId;e[r](n,(t=>{globalThis.postMessage({type:r,id:s,sourceMapId:o,data:t})}))}))})();',"Worker",void 0,void 0)}class Ot{static workerCount;constructor(){this.workers=null,this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<Ot.workerCount;)this.workers.push(new Lt);return this.active[e]=!0,this.workers.slice()}realse(e){this.workers&&(delete this.active[e],0===this.numActive()&&(this.workers.forEach((e=>{e.terminate()})),this.workers=void 0))}numActive(){return Object.keys(this.active).length}}const It=Math.floor(navigator.hardwareConcurrency/2);let Rt;Ot.workerCount=Math.max(Math.min(It,6),1);const Nt={longitude:104.08761,latitude:30.602939,height:1e4,pitch:-70,heading:0,roll:0,animation:!1},zt={animation:!1,timeline:!1,fullscreenButton:!1,sceneModePicker:!1,geocoder:!1,baseLayerPicker:!1,homeButton:!1,navigationHelpButton:!1,debug:!1,vrButton:!1,imageryProvider:!0,showRenderLoopErrors:!1,infoBox:!1,selectionIndicator:!1,showCredit:!1,creditContainer:document.createElement("div"),contextOptions:{webgl:{alpha:!1,depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,failIfMajorPerformanceCaveat:!1},allowTextureFilterAnisotropic:!0},showMask:!0,shouldAnimate:!0};const Ft=e=>{let t=[],i=e.radius,n=e.point,r=e.angle1?e.angle1:0,o=void 0===e.angle2?Math.PI/2:e.angle2,s=void 0===e.angle3?Math.PI/2:e.angle3,a=void 0===e.angle4?Math.PI/2:e.angle4;for(let l=0;l<=90;l++){const c=h.Math.toRadians(l);t.push(h.Math.toDegrees(n.longitude+i*Math.sin(c+r)*Math.sin(o))),t.push(h.Math.toDegrees(n.latitude+i*Math.sin(c)*Math.cos(n.latitude)*Math.sin(s))),t.push(n.height+e.length*(1+i)*Math.cos(c)*Math.sin(a))}return t},Bt=(e,t,i)=>{const n=h.Cartographic.fromCartesian(e);return t/h.Cartesian3.distance(h.Cartesian3.fromRadians(n.longitude,n.latitude,n.height),h.Cartesian3.fromRadians(n.longitude+1e-5,n.latitude,n.height))*i*1e-5};function kt(e){var t=parseFloat(""+e);return isNaN(t)?0:t=Math.round(100*e)/100}const Gt=(e,t,i)=>{let n=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x),r=h.Cartesian2.angleBetween(t,i);return(n<0||0==n&&0<(i.y-t.y)/(i.x-t.x))&&(r=2*Math.PI-r),r};const Ht=class{constructor(e){this._viewer=e,this._wmp=new h.WebMercatorProjection}fromScreenToCartesian3(e,t){let i=new h.Cartesian2(e,t);return 3===this._viewer.scene.mode?this._viewer.scene.globe.pick(this._viewer.camera.getPickRay(i),this._viewer.scene):this._viewer.camera.pickEllipsoid(i,this._viewer.scene.globe.ellipsoid)}fromCartesian3ToCartographic(e){return this._viewer.scene.globe.ellipsoid.cartesianToCartographic(e)}fromCartesian3ToScreen(e){if(e)return h.SceneTransforms.wgs84ToWindowCoordinates(this._viewer.scene,e)}fromCartesian3ToDegree(e){let t=this.fromCartesian3ToCartographic(e);return this.fromCartographicToDegree(t)}fromCartographicToDegree(e){return{lon:h.Math.toDegrees(e.longitude),lat:h.Math.toDegrees(e.latitude),height:e.height}}fromCartographicToCartesian3(e){return this._viewer.scene.globe.ellipsoid.cartographicToCartesian(e)}fromDegreesToCartographic(e){return h.Cartographic.fromDegrees(e.lon,e.lat,e.height)}fromDegreesToCartesian3(e){return h.Cartesian3.fromDegrees(e.lon,e.lat,e.height)}fromWGS84ToMercator(e){return this._wmp.project(e)}fromMercatorToWGS84(e){return this._wmp.unproject(e)}toLonLatAlt(e){var t=this._viewer.scene.globe.ellipsoid.cartesianToCartographic(e),i=h.Math.toDegrees(t.latitude);return[h.Math.toDegrees(t.longitude),i,t.height]}};class Vt{constructor(e){this.viewer=e,this._primitives=new Map,e.scene.postRender.addEventListener((()=>{const e=[];this._primitives.forEach(((t,i)=>{i.ready&&(t(),e.push(i))})),e.forEach((e=>{this._primitives.delete(e)}))}))}readyPromise(e){let t;const i=new Promise(((e,i)=>{t=e}));return this._primitives.set(e,t),i}}const Ut="pan",Wt="rotate",jt="scale",qt="x",Zt="y",Yt="z",$t="p",Xt={XPAN:"x-pan",YPAN:"y-pan",ZPAN:"z-pan",XROTATE:"x-rotate",YROTATE:"y-rotate",ZROTATE:"z-rotate",XROTATEX:"x-rotate-x",YROTATEY:"y-rotate-y",ZROTATEZ:"z-rotate-z",SURFACESCALE:"surface-scale",XSCALE:"x-scale",YSCALE:"y-scale",ZSCALE:"z-scale",PPAN:"p-pan"};const Kt=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Qt{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,i]=new Uint8Array(e,0,2);if(219!==t)throw new Error("Data does not appear to be in a KDBush format.");const n=i>>4;if(1!==n)throw new Error(`Got v${n} data when expected v1.`);const r=Kt[15&i];if(!r)throw new Error("Unrecognized array type.");const[o]=new Uint16Array(e,2,1),[s]=new Uint32Array(e,4,1);return new Qt(s,o,r,e)}constructor(e,t=64,i=Float64Array,n){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=i,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const r=Kt.indexOf(this.ArrayType),o=2*e*this.ArrayType.BYTES_PER_ELEMENT,s=e*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-s%8)%8;if(r<0)throw new Error(`Unexpected typed array class: ${i}.`);n&&n instanceof ArrayBuffer?(this.data=n,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+s+a,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+o+s+a),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+s+a,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+r]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=e,this.coords[this._pos++]=t,i}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Jt(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,i,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:o,nodeSize:s}=this,a=[0,r.length-1,0],l=[];for(;a.length;){const h=a.pop()||0,c=a.pop()||0,d=a.pop()||0;if(c-d<=s){for(let s=d;s<=c;s++){const a=o[2*s],h=o[2*s+1];a>=e&&a<=i&&h>=t&&h<=n&&l.push(r[s])}continue}const u=d+c>>1,p=o[2*u],m=o[2*u+1];p>=e&&p<=i&&m>=t&&m<=n&&l.push(r[u]),(0===h?e<=p:t<=m)&&(a.push(d),a.push(u-1),a.push(1-h)),(0===h?i>=p:n>=m)&&(a.push(u+1),a.push(c),a.push(1-h))}return l}within(e,t,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:n,coords:r,nodeSize:o}=this,s=[0,n.length-1,0],a=[],l=i*i;for(;s.length;){const h=s.pop()||0,c=s.pop()||0,d=s.pop()||0;if(c-d<=o){for(let i=d;i<=c;i++)ni(r[2*i],r[2*i+1],e,t)<=l&&a.push(n[i]);continue}const u=d+c>>1,p=r[2*u],m=r[2*u+1];ni(p,m,e,t)<=l&&a.push(n[u]),(0===h?e-i<=p:t-i<=m)&&(s.push(d),s.push(u-1),s.push(1-h)),(0===h?e+i>=p:t+i>=m)&&(s.push(u+1),s.push(c),s.push(1-h))}return a}}function Jt(e,t,i,n,r,o){if(r-n<=i)return;const s=n+r>>1;ei(e,t,s,n,r,o),Jt(e,t,i,n,s-1,1-o),Jt(e,t,i,s+1,r,1-o)}function ei(e,t,i,n,r,o){for(;r>n;){if(r-n>600){const s=r-n+1,a=i-n+1,l=Math.log(s),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(s-h)/s)*(a-s/2<0?-1:1);ei(e,t,i,Math.max(n,Math.floor(i-a*h/s+c)),Math.min(r,Math.floor(i+(s-a)*h/s+c)),o)}const s=t[2*i+o];let a=n,l=r;for(ti(e,t,n,i),t[2*r+o]>s&&ti(e,t,n,r);a<l;){for(ti(e,t,a,l),a++,l--;t[2*a+o]<s;)a++;for(;t[2*l+o]>s;)l--}t[2*n+o]===s?ti(e,t,n,l):(l++,ti(e,t,l,r)),l<=i&&(n=l+1),i<=l&&(r=l-1)}}function ti(e,t,i,n){ii(e,i,n),ii(t,2*i,2*n),ii(t,2*i+1,2*n+1)}function ii(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function ni(e,t,i,n){const r=e-i,o=t-n;return r*r+o*o}let ri=2e3,oi=1e3;const si={"-1":"RIGHT",1:"LEFT",0:"TOP"};function ai(e,t){const{west:i,north:n,east:r,south:o}=e,{west:s,north:a,east:l,south:h}=t,c=i>s?s:i,d=o>h?h:o,u=r>l?r:l,p=n>a?n:a;return new Cesium.Rectangle(c,d,u,p)}function li(e,t,i){e.west-=t,e.south-=i,e.north+=i,e.east+=t}function hi(e,t){e.point.show=t,e.label.show=t}const ci="V1.0.0";console.log(`%ccesiumMap-version:${ci}`,"color:green");const di={modelEditer:class extends g{constructor(e){var t;if(super(),e=h.defaultValue(e,h.defaultValue.EMPTY_OBJECT),this._viewer=e.viewer,!h.defined(this._viewer))throw new h.DeveloperError("viewer is required.");this._model=e.model,this._readyHelper=e.readHelper,h.defined(this._readyHelper)||(this._readyHelper=new Vt(this._viewer)),this.lengthScale=null!==(t=e.lengthScale)&&void 0!==t?t:1,this.editorXAngle=0,this.editorYAngle=0,this.editorZAngle=0,this.editorMode=null,this.editorAxis=null,this._primitives=null,this.oldMatrix=null,this.originMatrix=null,this.originEditorMatrix=null,this.handler=null,this.lastScale=null,this.highlightPrimitive=null,this.primitiveCenter=null,this.rootTransform=null,this.primitiveRadius=null,this.editMovingEvent=new h.Event,this.editEndEvent=new h.Event,this.zoomAxis=1,this.subtract=null,this.axisCenter=null,this.originCenter=null,this.axisScale=null,this.mode=e.mode||"translate",this.helper={},this.currentModelScale=null,this.currentModelRotation=null,this.currentModelTrans=null,this.coorTrans=new Ht(this._viewer)}_drawAxis(e){console.log(e);const t=e.lon?e.lon:0,i=e.lat?e.lat:0,n=e.height?e.height:0;return new h.Primitive({geometryInstances:new h.GeometryInstance({id:e.id,geometry:new h.PolylineGeometry({vertexFormat:h.PolylineMaterialAppearance.VERTEX_FORMAT,positions:h.Cartesian3.fromDegreesArrayHeights([h.Math.toDegrees(e.point.longitude),h.Math.toDegrees(e.point.latitude),e.point.height,h.Math.toDegrees(e.point.longitude+t),h.Math.toDegrees(e.point.latitude+i),e.point.height+n]),width:20,height:e.point.height}),attributes:{color:h.ColorGeometryInstanceAttribute.fromColor(h.Color.RED.withAlpha(.1))}}),appearance:this._changeAxisAppearance(!1),releaseGeometryInstances:!1})}_changeAxisAppearance(e){return new h.PolylineMaterialAppearance({material:new h.Material({fabric:{type:"PolylineArrow",uniforms:{color:h.Color.fromAlpha(h.Color.YELLOW,e?1:.6)}}})})}_drawAxisArc(e){return new h.Primitive({geometryInstances:new h.GeometryInstance({geometry:new h.PolylineGeometry({positions:h.Cartesian3.fromDegreesArrayHeights(Ft(e)),width:4,vertexFormat:h.PolylineColorAppearance.VERTEX_FORMAT}),id:e.id,attributes:{color:h.ColorGeometryInstanceAttribute.fromColor(h.Color.CORNFLOWERBLUE.withAlpha(.6))}}),appearance:new h.PolylineColorAppearance({translucent:!0})})}_drawSurfaceScale(e,t){return new h.Primitive({geometryInstances:new h.GeometryInstance({geometry:h.PolygonGeometry.fromPositions({positions:h.Cartesian3.fromDegreesArrayHeights(t),vertexFormat:h.EllipsoidSurfaceAppearance.VERTEX_FORMAT,height:e.height}),id:Xt.SURFACESCALE,attributes:{color:h.ColorGeometryInstanceAttribute.fromColor(h.Color.ORANGE.withAlpha(.5))}}),appearance:new h.PerInstanceColorAppearance({translucent:!0})})}_drawPanPolygon(e){const t=this.primitiveCenter,i=h.Math.toDegrees(e.longitude-Bt(t,this.primitiveRadius,.1)),n=h.Math.toDegrees(e.latitude-Bt(t,this.primitiveRadius,.1)*Math.cos(e.latitude)),r=h.Math.toDegrees(e.longitude),o=h.Math.toDegrees(e.latitude);return new h.Primitive({geometryInstances:new h.GeometryInstance({geometry:new h.RectangleGeometry({rectangle:h.Rectangle.fromDegrees(i,n,r,o),vertexFormat:h.PerInstanceColorAppearance.VERTEX_FORMAT,height:e.height}),id:Xt.PPAN,attributes:{color:h.ColorGeometryInstanceAttribute.fromColor(h.Color.MAGENTA.withAlpha(.5))}}),appearance:new h.PerInstanceColorAppearance({translucent:!0})})}_setAxisScale(e){this.axisScale=e;const t=h.Matrix4.fromScale(new h.Cartesian3(e,e,e),new h.Matrix4),i=h.Transforms.eastNorthUpToFixedFrame(this.axisCenter),n=h.Matrix4.inverse(i,new h.Matrix4);for(let e=0;e<this._primitives.length;e++){let r=h.Matrix4.getScale(this._primitives.get(e).modelMatrix,new h.Cartesian3);r=new h.Cartesian3(Math.round(r.x),Math.round(r.y),Math.round(r.z));const o=h.Matrix4.inverse(h.Matrix4.fromScale(r,new h.Matrix4),new h.Matrix4);h.Matrix4.multiply(n,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix),h.Matrix4.multiply(o,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix),h.Matrix4.multiply(i,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix),h.Matrix4.multiply(n,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix),h.Matrix4.multiply(t,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix),h.Matrix4.multiply(i,this._primitives.get(e).modelMatrix,this._primitives.get(e).modelMatrix)}this.lastScale=e}_cameraChanged(){if(!this._primitives||!this._primitives.isDestroyed()){const e=this._primitives._primitives.find((e=>e._instanceIds[0]===Xt.XPAN));if(e&&e._boundingSpheres[0]){let t=e._boundingSpheres[0].radius,i=Math.round(this.primitiveRadius/t*this.zoomAxis);i=i>1?i:1,this._setAxisScale(i)}}}_getPrimitiveData(){this.primitiveCenter=h.Matrix4.getTranslation(this._model.modelMatrix.clone(),new h.Cartesian3),this.rootTransform=this._model.modelMatrix.clone(),this.primitiveRadius=this._model.boundingSphere.radius*this.lengthScale}_getPointsByMovement(e,t,i){let n=h.Matrix4.inverseTransformation(h.Matrix4.IDENTITY,new h.Matrix4),r=this._viewer.scene.camera.position,o=h.Matrix4.multiplyByPoint(n,r,new h.Cartesian3),s=h.Matrix4.multiplyByPoint(n,e,new h.Cartesian3),a=h.Matrix4.multiplyByPoint(n,t,new h.Cartesian3),l=h.Cartesian3.normalize(h.Cartesian3.subtract(s,o,new h.Cartesian3),new h.Cartesian3),c=h.Cartesian3.normalize(h.Cartesian3.subtract(a,o,new h.Cartesian3),new h.Cartesian3),d=null;if(this._getPrimitiveData(),this.editorMode===Ut||this.editorMode===jt){const e=h.Plane.fromPointNormal(this.primitiveCenter,this._viewer.scene.globe.ellipsoid.geodeticSurfaceNormal(this.primitiveCenter,new h.Cartesian3));d=i?e:h.Plane.fromPointNormal(this.primitiveCenter,this._viewer.scene.camera.direction)}else if(this.editorMode===Wt){let e=h.Cartographic.fromCartesian(this.primitiveCenter),t=h.Math.toDegrees(e.longitude),i=h.Math.toDegrees(e.latitude),n=e.height,r=h.Cartesian3.fromDegrees(t,i,n),o=null;this.editorAxis===Yt?o=h.Cartesian3.fromDegrees(t,i,n+5e-4):this.editorAxis===Zt?o=h.Cartesian3.fromDegrees(t,i+5e-4,n):this.editorAxis===qt&&(o=h.Cartesian3.fromDegrees(t+5e-4,i,n));const s=h.Cartesian3.normalize(h.Cartesian3.subtract(o,r,new h.Cartesian3),new h.Cartesian3);d=h.Plane.fromPointNormal(this.primitiveCenter,s)}let u=null,p=null,m=new h.Ray(o,l),g=new h.Ray(o,c);return m&&g&&d&&(u=h.IntersectionTests.rayPlane(m,d),p=h.IntersectionTests.rayPlane(g,d)),u&&p?{start:u,end:p}:null}_getAxisTrans(e,t,i){let n=h.Cartographic.fromCartesian(e),r=h.Cartographic.fromCartesian(t),o=0,s=0,a=0;return i===qt?o=r.longitude-n.longitude:i===Zt?s=r.latitude-n.latitude:i===Yt?a=r.height-n.height:i===$t&&(o=r.longitude-n.longitude,s=r.latitude-n.latitude),this._getPanOffset(o,s,a)}_getPanOffset(e,t,i){this._getPrimitiveData();const n=h.Cartographic.fromCartesian(this.primitiveCenter),r=h.Cartesian3.fromRadians(n.longitude,n.latitude,0),o=h.Cartesian3.fromRadians(n.longitude+e,n.latitude+t,i);return this.subtract=h.Cartesian3.subtract(o,r,new h.Cartesian3),h.Cartesian3.subtract(o,r,new h.Cartesian3)}_setTranslation(e){const t=h.Matrix4.setTranslation(h.Matrix4.IDENTITY,e,new h.Matrix4),i=this._model.modelMatrix.clone(),n=h.Matrix4.multiply(t,i,new h.Matrix4);this._model.modelMatrix=n,this._setAxisTrans(t)}_setAxisTrans(e){this.axisCenter||(this.axisCenter=this._primitives.get(0).geometryInstances.geometry._positions[0]);for(let t=0;t<this._primitives.length;t++)this._primitives.get(t).modelMatrix=h.Matrix4.multiply(e,this._primitives.get(t).modelMatrix,new h.Matrix4);this.axisCenter=h.Cartesian3.add(this.axisCenter,this.subtract,new h.Cartesian3)}_getMatrixByRotation(e,t,i){const n=h.Matrix3.fromRotationZ(i),r=h.Matrix3.fromRotationX(e),o=h.Matrix3.fromRotationY(t),s=h.Matrix3.multiply(r,n,new h.Matrix3),a=h.Matrix3.multiply(o,s,new h.Matrix3),l=h.Matrix4.fromRotationTranslation(a),c=h.Transforms.eastNorthUpToFixedFrame(this.axisCenter),d=h.Matrix4.inverse(c,new h.Matrix4),u=h.Matrix4.multiply(this._model.modelMatrix.clone(),this.rootTransform,new h.Matrix4),p=h.Matrix4.multiply(d,u,new h.Matrix4),m=h.Matrix4.multiply(l,p,new h.Matrix4),g=h.Matrix4.multiply(c,m,new h.Matrix4);return h.Matrix4.multiply(g,h.Matrix4.inverse(this.rootTransform,new h.Matrix4),new h.Matrix4).clone()}_setRotation(e){this._model.modelMatrix=e}scale(e){const t=h.Matrix4.multiplyByScale(this._model.modelMatrix,new h.Cartesian3(e[0],e[1],e[2]),new h.Matrix4);this._model.modelMatrix=t,this._cameraChanged()}_getPrimitiveAppearance(e,t){let i=new h.PolylineColorAppearance({translucent:!0});switch(e){case Xt.XPAN:case Xt.YPAN:case Xt.ZPAN:case Xt.XSCALE:case Xt.YSCALE:case Xt.ZSCALE:i=this._changeAxisAppearance(t);break;case Xt.XROTATE:case Xt.YROTATE:case Xt.ZROTATE:i=new h.PolylineColorAppearance({translucent:!t});break;case Xt.SURFACESCALE:case Xt.PPAN:i=new h.PerInstanceColorAppearance({translucent:!t});break;case Xt.XROTATEX:case Xt.YROTATEY:case Xt.ZROTATEZ:i=this._changeAxisAppearance(!1)}return i}_mouseMoveHandle(e){if(!this._viewer.scene.pick(e.endPosition))return;let t=this._viewer.scene.pickPosition(e.startPosition),i=this._viewer.scene.pickPosition(e.endPosition);if(t&&i||(t=this._viewer.scene.globe.pick(this._viewer.camera.getPickRay(e.startPosition),this._viewer.scene),i=this._viewer.scene.globe.pick(this._viewer.camera.getPickRay(e.endPosition),this._viewer.scene)),t&&i)if(this.editorMode){if(this._getPrimitiveData(),this.editorMode===Ut){const e=this.editorAxis!==Yt,n=this._getPointsByMovement(t,i,e);if(n){const e=this._getAxisTrans(n.start,n.end,this.editorAxis);this._setTranslation(e)}this.currentModelTrans=this.coorTrans.fromCartesian3ToDegree(n.end)}else if(this.editorMode===Wt){const e=this._getPointsByMovement(t,i,null);let n=null;if(e){const t=h.Cartesian3.ZERO,i=h.Cartesian3.subtract(e.end,this.primitiveCenter,new h.Cartesian3),r=h.Cartesian3.subtract(e.start,this.primitiveCenter,new h.Cartesian3);this.editorAxis===Yt?(this.editorZAngle=-Gt(new h.Cartesian2(t.x,t.y),new h.Cartesian2(i.x,i.y),new h.Cartesian2(r.x,r.y)),n=[0,0,this.editorZAngle]):this.editorAxis===Zt?(this.editorYAngle=-Gt(new h.Cartesian2(t.x,t.z),new h.Cartesian2(i.x,i.z),new h.Cartesian2(r.x,r.z)),n=[0,this.editorYAngle,0]):this.editorAxis===qt&&(this.editorXAngle=Gt(new h.Cartesian2(t.y,t.z),new h.Cartesian2(i.y,i.z),new h.Cartesian2(r.y,r.z)),n=[this.editorXAngle,0,0]);const o=this._getMatrixByRotation(...n);this._setRotation(o);const s=h.Transforms.fixedFrameToHeadingPitchRoll(this._model.modelMatrix),{heading:a,pitch:l,roll:c}=s,d=h.Math.toDegrees(c),u=h.Math.toDegrees(l),p=h.Math.toDegrees(a),m=[d<0?d+360:d,u<0?u+360:u,p<0?p+360:p].map((e=>kt(e)));this.currentModelRotation=m}}else if(this.editorMode===jt){const e=this.editorAxis!==Yt,n=this._getPointsByMovement(t,i,e);if(n){const e=h.Cartesian3.ZERO,t=h.Cartesian3.subtract(n.end,this.primitiveCenter,new h.Cartesian3),i=h.Cartesian3.subtract(n.start,this.primitiveCenter,new h.Cartesian3),r=h.Cartesian2.distance(h.Cartesian2.fromCartesian3(t),h.Cartesian2.fromCartesian3(e)),o=h.Cartesian2.distance(h.Cartesian2.fromCartesian3(i),h.Cartesian2.fromCartesian3(e));let s=null;s=this.editorAxis===qt?[r/o,1,1]:this.editorAxis===Zt?[1,r/o,1]:[1,1,r/o],this.scale(s);const a=h.Matrix4.getScale(this._model.modelMatrix,new h.Cartesian3);this.currentModelScale=[a.x,a.y,a.z].map((e=>kt(e)))}}this.editMovingEvent.raiseEvent(this.rootTransform)}else{const t=this._viewer.scene.pick(e.endPosition),i=((e,t)=>{let i=e.scene.pickPosition(t);if(i){if(h.Cartographic.fromCartesian(i).height<0&&e.scene.globe){let n=e.camera.getPickRay(t);i=e.scene.globe.pick(n,e.scene)}}else i=e.camera.pickEllipsoid(t,e.scene.globe.ellipsoid);return i})(this._viewer,e.endPosition),n=this.highlightPrimitive;if(h.defined(t)&&t.id&&i){if(null!==n&&t.id===n.id||"string"!=typeof t.id)return;null!==n&&n.primitive&&(n.primitive.appearance=this._getPrimitiveAppearance(n.id,!1));let e=!1;for(const i in Xt){const n=Xt[i];t.id===n&&(e=!0)}if(e){const e=this._getPrimitiveAppearance(t.id,!0);e&&(t.primitive.appearance=e),this.highlightPrimitive=t}}else null!==n&&n.primitive&&(n.primitive.appearance=this._getPrimitiveAppearance(n.id,!1),this.highlightPrimitive=null)}}_getModelMatrixByMatrix(e){const t=this._getModelCenterByMatrix(e);return this._getPrimitiveData(),this.subtract=h.Cartesian3.subtract(t,this.primitiveCenter,new h.Cartesian3),h.Matrix4.setTranslation(h.Matrix4.IDENTITY,this.subtract,new h.Matrix4)}_getModelCenterByMatrix(e){const t=h.Matrix4.multiply(this._model.modelMatrix.clone(),this.rootTransform,new h.Matrix4),i=h.Matrix4.multiplyByPoint(h.Matrix4.inverse(t,new h.Matrix4),this.primitiveCenter,new h.Cartesian3),n=h.Matrix4.multiply(e,this.rootTransform,new h.Matrix4);return h.Matrix4.multiplyByPoint(n,i,new h.Cartesian3)}_setCameraEnable(e){this._viewer.scene.screenSpaceCameraController.enableRotate=e,this._viewer.scene.screenSpaceCameraController.enableTranslate=e,this._viewer.scene.screenSpaceCameraController.enableZoom=e,this._viewer.scene.screenSpaceCameraController.enableTilt=e,this._viewer.scene.screenSpaceCameraController.enableLook=e}_leftUpHandle(){const{id:e}=this._model,t=this.coorTrans.fromCartesian3ToDegree(h.Matrix4.getTranslation(this._model._modelMatrix,new h.Cartesian3));this.currentModelTrans=t,this.editorMode===Ut&&this.currentModelTrans?this.fire("model:translate",{data:t,id:e,model:this._model}):this.editorMode===jt&&this.currentModelScale?this.fire("model:scale",{data:this.currentModelScale,id:e,model:this._model}):this.editorMode===Wt&&this.currentModelRotation&&this.fire("model:rotate",{data:this.currentModelRotation,id:e,model:this._model}),this._setCameraEnable(!0);const i=this.highlightPrimitive;null!=i&&i.primitive&&(i.primitive.appearance=this._getPrimitiveAppearance(i.id,!1),this.highlightPrimitive=null,this.editEndEvent.raiseEvent(this.rootTransform)),this.editorMode=null,this.currentModelTrans=null,this.currentModelScale=null,this.currentModelRotation=null}_leftDownHandle(e){let t=this._viewer.scene.pick(e.position),i=this._viewer.scene.pickPosition(e.position);if(i&&h.Cartographic.fromCartesian(i).height<0){const t=new h.Cartesian2(e.position.x,e.position.y),n=this._viewer.camera.getPickRay(t);i=this._viewer.scene.globe.pick(n,this._viewer.scene)}const n=Object.values(Xt);h.defined(t)&&t.id&&"string"==typeof t.id&&n.includes(t.id)&&(this._setCameraEnable(!1),this.editorAxis=t.id.toString().split("-")[0],this.editorMode=t.id.slice(t.id.indexOf("-")+1))}setModel(e){if(this._model=e,!h.defined(this._model))throw new h.DeveloperError("edit model is required.")}start(){if(!h.defined(this._model))throw new h.DeveloperError("edit model is required.");this.startEditing()}_setPrimitiveAppearance(){if(!this._primitives||!this._model)return;const e=e=>{this._primitives._primitives.forEach((t=>{const i=t.geometryInstances?t.geometryInstances.id:t._instanceIds[0];this.helper[e].includes(i)?(t.show=!0,"translate"===e&&"p-pan"!==i&&(t.appearance=this._changeAxisAppearance(!1))):t.show=!1}))};switch(this.mode){case"translate":e("translate");break;case"rotate":e("rotate");break;case"scale":e("scale")}}startEditing(){this._getPrimitiveData(),this.originEditorMatrix=h.Matrix4.IDENTITY,this.axisCenter||(this.axisCenter=this.primitiveCenter,this.originCenter=this.primitiveCenter,this.originMatrix=this._model.modelMatrix.clone());const e=h.Cartographic.fromCartesian(this.axisCenter);if(this._primitives)this._setPrimitiveAppearance();else{this._primitives=new h.PrimitiveCollection,this._viewer.scene.primitives.add(this._primitives);const t=this.axisCenter,i=Ft({point:e,radius:Bt(t,this.primitiveRadius,.13),length:.13*this.primitiveRadius,angle1:Math.PI/2,angle4:0});i.unshift(h.Math.toDegrees(e.longitude),h.Math.toDegrees(e.latitude),e.height),i.push(h.Math.toDegrees(e.longitude),h.Math.toDegrees(e.latitude),e.height);const n=this.primitiveRadius;this._primitives.add(this._drawAxis({point:e,id:Xt.YPAN,lat:Bt(t,n,.25)*Math.cos(e.latitude)})),this._primitives.add(this._drawAxis({point:e,id:Xt.XPAN,lon:Bt(t,n,.25)})),this._primitives.add(this._drawAxis({point:e,id:Xt.ZPAN,height:.25*n})),this._primitives.add(this._drawAxis({point:e,id:Xt.XROTATEX,lat:Bt(t,n,.25)*Math.cos(e.latitude)})),this._primitives.add(this._drawAxis({point:e,id:Xt.YROTATEY,lon:Bt(t,n,.25)})),this._primitives.add(this._drawAxis({point:e,id:Xt.ZROTATEZ,height:.25*n})),this._primitives.add(this._drawAxisArc({point:e,id:Xt.XROTATE,radius:Bt(t,n,.15),length:.15*n,angle2:0})),this._primitives.add(this._drawAxisArc({point:e,id:Xt.YROTATE,radius:Bt(t,n,.15),length:.15*n,angle3:0})),this._primitives.add(this._drawAxisArc({point:e,id:Xt.ZROTATE,radius:Bt(t,n,.15),length:.15*n,angle1:Math.PI/2,angle4:0})),this._primitives.add(this._drawAxis({point:e,id:Xt.YSCALE,lat:Bt(t,n,.15)*Math.cos(e.latitude)})),this._primitives.add(this._drawAxis({point:e,id:Xt.XSCALE,lon:Bt(t,n,.15)})),this._primitives.add(this._drawAxis({point:e,id:Xt.ZSCALE,height:.15*n})),this._primitives.add(this._drawPanPolygon(e)),this.helper.translate=[Xt.YPAN,Xt.XPAN,Xt.ZPAN,Xt.PPAN],this.helper.rotate=[Xt.XROTATE,Xt.YROTATE,Xt.ZROTATE,Xt.ZROTATEZ,Xt.XROTATEX,Xt.YROTATEY],this.helper.scale=[Xt.YSCALE,Xt.XSCALE,Xt.ZSCALE],this._setPrimitiveAppearance();const r=this._primitives.get(this._primitives.length-1);this._readyHelper.readyPromise(r).then((()=>{this._cameraChanged()})),this.lastScale=1,this.highlightPrimitive=null,this.handler=new h.ScreenSpaceEventHandler(this._viewer.scene.canvas),this.handler.setInputAction(this._mouseMoveHandle.bind(this),h.ScreenSpaceEventType.MOUSE_MOVE),this.handler.setInputAction(this._leftUpHandle.bind(this),h.ScreenSpaceEventType.LEFT_UP),this.handler.setInputAction(this._leftDownHandle.bind(this),h.ScreenSpaceEventType.LEFT_DOWN)}}reset(){if(this.editorXAngle=0,this.editorYAngle=0,this.editorZAngle=0,this._primitives&&this.originMatrix&&this.originEditorMatrix){this._model.modelMatrix=this.originMatrix,this.axisCenter=this.originCenter;for(let e=0;e<this._primitives.length;e++)this._primitives.get(e).modelMatrix=this.originEditorMatrix.clone();const e=this._primitives.get(this._primitives.length-1);this._readyHelper.readyPromise(e).then((()=>{this._cameraChanged()}))}}translation(e,t){switch(e){case qt:this._setTranslation(this._getPanOffset(1e-5*t,0,0));break;case Zt:this._setTranslation(this._getPanOffset(0,1e-5*t,0));break;case Yt:this._setTranslation(this._getPanOffset(0,0,1e-5*t*1e6))}}rotation(e,t){switch(this._getPrimitiveData(),e){case qt:this._setRotation(this._getMatrixByRotation(h.Math.toRadians(t),0,0));break;case Zt:this._setRotation(this._getMatrixByRotation(0,h.Math.toRadians(t),0));break;case Yt:this._setRotation(this._getMatrixByRotation(0,0,h.Math.toRadians(t)))}}copyMatrix(){return h.Matrix4.toArray(this._model.modelMatrix).toString()}destroy(){this._model&&this.reset(),this._clearPrimitive(),this.clearListeners()}getModel(){return this._model}save(){if(this._primitives&&!this._primitives.isDestroyed()&&this._model)return this.originMatrix=this._model.modelMatrix.clone(),this.originEditorMatrix=this._primitives.get(0).modelMatrix.clone(),this._clearPrimitive(),this._model.modelMatrix.clone()}pasteMatrix(e){this._setAxisTrans(this._getModelMatrixByMatrix(e)),this._model.modelMatrix=h.Matrix4.fromArray(e)}_clearPrimitive(){this._primitives&&this._viewer.scene.primitives.remove(this._primitives),this._removeHandler(),this.handler&&this.handler.destroy(),this._primitives=void 0,this.axisCenter=void 0}_removeHandler(){this.handler&&(this.handler.removeInputAction(h.ScreenSpaceEventType.MOUSE_MOVE),this.handler.removeInputAction(h.ScreenSpaceEventType.LEFT_UP),this.handler.removeInputAction(h.ScreenSpaceEventType.LEFT_DOWN))}setMode(e){this.mode=e,this._setPrimitiveAppearance()}getMode(){return this.mode}},featureAvoid:function(e,t,i){const n=e.scene;ri=e.scene.canvas.clientWidth,oi=e.scene.canvas.screenHeight;const r=n.mapProjection.ellipsoid,o=n.camera.positionWC,s=[];let a,l,h,c,d,u,p,m,g,f,y,v,x,w,C;if(function(e,t,i,n){if(!Cesium.defined(e))return;const r=e.length;let o,s;for(let a=0;a<r;++a){if(o=e[a],hi(o,!1),s=o.point,!o.show||!n.isPointVisible(s.position))continue;const r=s.computeScreenSpacePosition(i);!Cesium.defined(r)||r.x<0||r.x>ri||r.y<0||r.y>oi||t.push({name:e[a].label.text,index:a,labelPoint:e[a],checked:!1,coord:r})}}(t,s,n,new Cesium.EllipsoidalOccluder(r,o)),h=s.length,0==h)return;const _=new Qt(h,64,Uint32Array);for(let e=0;e<h;++e)_.add(s[e].coord.x,s[e].coord.y);for(_.finish(),a=0;a<h;++a){const e=s[a];if(e.checked)continue;C=e.coord,g=e.labelPoint;const{label:t,point:r}=g;let o=Cesium.Billboard.getScreenSpaceBoundingBox(r,C);if(!o.width){console.log("还未获取到数据");break}let{x:h,y:b,width:M,height:A}=o,T=h+M,P=b+A;if(x=new Cesium.Rectangle(h,b,T,P),i.collides(x))continue;const S=t.computeScreenSpacePosition(n);y=M/2,v=A/2;let E=Cesium.Label.getScreenSpaceBoundingBox(t,S),{x:D,y:L,width:O,height:I}=E,R=D+O,N=L+I;w=new Cesium.Rectangle(D,L,R,N);let z=i.collides(w);if(e.name,f=si[t.horizontalOrigin],z&&!r.showLabel){let e;switch(f){case"TOP":e=["LEFT","RIGHT"];break;case"LEFT":e=["RIGHT","TOP"];break;case"RIGHT":e=["LEFT","TOP"]}let t=[C.x-O/2,C.y-I/2,C.x+O/2,C.y+I/2];for(let n=0;n<e.length;n++){switch(f=e[n],f){case"LEFT":case"RIGHT":const e=Cesium.HorizontalOrigin[f];w=new Cesium.Rectangle(t[0]+(y+O/2)*e,t[1],t[2]+(y+O/2)*e,t[3]);break;case"TOP":w=new Cesium.Rectangle(t[0],t[1]+v,t[2],t[3]+v)}if(z=i.collides(w),!z)break}}if(!z){if(r.showLabel)c=w,t.show=!0,r.show=!1,t.horizontalOrigin=Cesium.HorizontalOrigin.CENTER,t.verticalOrigin=Cesium.VerticalOrigin.CENTER,t.pixelOffset=new Cesium.Cartesian2(0,0);else{switch(t.show=!0,r.show=!0,f){case"LEFT":case"RIGHT":t.horizontalOrigin=Cesium.HorizontalOrigin[f],t.verticalOrigin=Cesium.VerticalOrigin.CENTER,t.pixelOffset=new Cesium.Cartesian2(t.horizontalOrigin*(y/r.scale),0);break;case"TOP":t.horizontalOrigin=Cesium.HorizontalOrigin.CENTER,t.verticalOrigin=Cesium.VerticalOrigin.BOTTOM,t.pixelOffset=new Cesium.Cartesian2(0,v/r.scale*-1)}c=ai(x,w)}for(li(c,4,4),i.insert(e.index+"point",c),d=_.range(c.west,c.south,c.east,c.north),u=d.length,l=0;l<u;++l)p=d[l],m=s[p],m.checked=!0}}}},ui={version:ci,Map:class extends g{constructor(e){super(),this.options=Object.assign({},e),this.target=e.container,this._init()}_init(){const e=this.options,t=this.target,i=Object.assign({},zt,e.viewerOptions);this.viewOptions=Object.assign({},Nt,this.options.viewOptions),this.viewer=new h.Viewer(t,i),this.scene=this.viewer.scene,this.primitives=this.scene.primitives,this.imageryLayers=this.viewer.imageryLayers,this.setView(this.viewOptions),this.scene.fxaa=!1,this.viewer.scene.screenSpaceCameraController.inertiaZoom=0,this.scene.postProcessStages.fxaa.enabled=!0,this.scene.globe.depthTestAgainstTerrain=!1,this.scene.camera.percentageChanged=.01,this.viewer.scene.screenSpaceCameraController.inertiaSpin=0,this.viewer.scene.screenSpaceCameraController.inertiaTranslate=0,this.viewer.scene.screenSpaceCameraController.inertiaZoom=0,this.dispatcher=new St((Rt||(Rt=new Ot),Rt),this),this.controlManager=new A(this),this.baseLayerManager=new k(this),this.sourceManager=new D(this),this.layerManager=new At(this),this.viewer.camera.changed.addEventListener(this.cameraChanged.bind(this)),this.viewer.scene.preRender.addEventListener(this.scenePreRender.bind(this)),this.setTerrain(e.terrain)}viewToHome(){this.setView(view)}setView(e){const{longitude:t,latitude:i,height:n,pitch:r,heading:o,roll:s,animation:a}=e,l=h.Cartesian3.fromDegrees(t,i,n),c={heading:h.Math.toRadians(o),pitch:h.Math.toRadians(r),roll:s};a?this.viewer.scene.camera.flyTo({destination:l,orientation:c,complete:()=>{}}):this.viewer.camera.setView({destination:l,orientation:c})}async setTerrain(e){if(!e)return;const t=await h.CesiumTerrainProvider.fromUrl(e.url);return this.viewer.terrainProvider=t,t}addControl(e,t){return this.controlManager.add(e,t)}addBaseLayer(e){return this.baseLayerManager.add(e)}getBaseLayer(e){return this.baseLayerManager.get(e)}removeBaseLayer(e){this.baseLayerManager.remove(e)}addLayer(e){return this.layerManager.add(e)}getLayer(e){return this.layerManager.get(e)}removeLayer(e){this.layerManager.remove(e)}addSource(e){return this.sourceManager.add(e)}getSource(e){return this.sourceManager.get(e)}removeSource(e){this.sourceManager.remove(e)}cameraChanged(){}scenePreRender(){}},Tool:di};return r=r.default})()));